 Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:  none
 *  The original Doom description was none, basically because this file
 *  has everything. This ties up the game logic, linking the menu and
 *  input code to the underlying game by creating & respawning players,
 *  building game tics, calling the underlying thing logic.
 *
 *-----------------------------------------------------------------------------
  Needs access to LFB. Data. SKY handling - still the wrong place. killough cph - only used for playback  cph - record straight to file  CPhipps - moved *_loadgame vars here ok to save / end game if true, exit with report on completion if true, run at full speed -- killough for comparative timing purposes for comparative timing purposes for comparative timing purposes only if started as net death only true if packets are broadcast player taking events and displaying view being displayed gametic at level start killough 9/29/98: for demo sync  for intermission quit after playing a demo from cmdline parms for world map / intermission jff 4/18/98 wolf levels present CPhipps - static always running?          // phares CPhipps - total time for all completed levels controls (have defaults) phares 3/7/98     |     V     ^     | phares 3/7/98 phares 4/13/98 phares    |    V cph - map overlay cph - map rotation phares 4/13/98    ^    | phares killough 2/22/98: screenshot key 180 degree reverse                    // phares + slow turn CPhipps - made lots of key/button state vars static for accelerative turning allow [-1] mouse values are used once scrollwheel values joystick values are repeated allow [-1] Game events info Event triggered by local player, to send Slot to load if gameaction == ga_loadgame Description to save in savegame if gameaction == ga_savegamejff 3/24/98 declare startskill external, define defaultskill herenote 0-basednote 1-based killough 2/8/98: make corpse queue variable in size killough 2/8/98 phares 8/10/98 for statistics driver G_BuildTiccmd Builds a ticcmd from all of the available inputs or reads it from the demo buffer. If recording a demo, write it out phares cphipps - remove needless I_BaseTiccmd call, just set the ticcmd to zero  phares use two stage accelerative turning on the keyboard and joystick slow turn turn 180 degrees in one keystroke?                           // phares    |    V    ^    | phares let movement keys cancel each other out strafe with scrollwheel  buttons clear double clicks if hit use button Toggle between the top 2 favorite weapons.                   // phares If not currently aiming one of these, switch to              // phares the favorite. Only switch if you possess the weapon.         // phares killough 3/22/98: Perform automatic weapons switch here rather than in p_pspr.c, except in demo_compatibility mode. killough 3/26/98, 4/2/98: fix autoswitch when no weapons are left killough phares phares 02/26/98: Added gamemode checks I don't know why this is needed, but it is killough 5/2/98: reformatted killough 3/22/98: For network and demo consistency with the new weapons preferences, we must do the weapons switches here instead of in p_user.c. But for old demos we must do it in p_user.c according to the old rules. Therefore demo_compatibility determines where the weapons switch is made. killough 2/8/98: Allow user to switch to fist even if they have chainsaw. Switch to fist or chainsaw based on preferences. Switch to shotgun or SSG based on preferences. only select chainsaw from '1' if it's owned, it's not already in use, and the player prefers it or the fist is already in use, or the player does not have the berserker strength. Select SSG from '3' only if it's owned and the player does not have a shotgun, or if the shotgun is already in use, or if the SSG is not already in use and the player prefers it. killough 2/8/98, 3/22/98 -- end of weapon selection changes something is messed up with the weapon switching code above allowing it to give values greater then wp_nochange which really screws the game up mouse forward double click strafe double click mead  Don't want to strafe as fast as turns. mead now have enough dynamic range 2-10-00  CPhipps - special events (game new/load/save/pause) G_RestartLevel G_DoLoadLevel Set the sky map. First thing, we have a dummy sky texture name,  a flat. The data is in the WAD only because  we look for an actual index, instead of simply  setting one. DOOM determines the sky texture to be used depending on the current episode, and the game version. || gamemode == pack_tnt   //jff 3/27/98 sorry guys pack_tnt,pack_plut || gamemode == pack_plut) //aren't gamemodes, this was matching retailjff 3/27/98 and lets not forget about DOOM and Ultimate DOOM huh? Special Edition skyjff 3/27/98 end sky setting fix for time calculation killough 9/29/98 force a wipe initialize the msecnode_t freelist.                     phares 3/25/98 any nodes in the freelist are gone by now, cleared by Z_FreeTags() when the previous level ended or player died.extern msecnode_t *headsecnode; // phares 3/25/98headsecnode = NULL; view the guy you are playing clear cmd building stuff killough 5/13/98: in case netdemo has consoleplayer other than green killough: make -timedemo work on multilevel demos Move to end of function to minimize noise -- killough 2/22/98: G_Responder Get info needed to make ticcmd_ts for the players. allow spy mode changes even during the demo killough 2/22/98: even during DM demo killough 11/98: don't autorepeat spy mode switch spy mode killough 3/7/98: switch status bar views too any other key pops up menu if in demos killough 8/2/98: enable automap in -timedemo demos killough 9/29/98: make any key pop up menu regardless of which kind of demo, and allow other events during playback killough 9/29/98: allow user to pause demos during playback killough 10/98: Don't pop up menu, if paused in middle of demo playback, or if automap active. Don't suck up keys, which may be cheats finale ate the event phares eat key down events always let key up events filter down eat events eat events G_Ticker Make ticcmd_ts for the players. do player reborns if needed do things to change the game state force players to be initialized on level reload For revenant tracers and RNG -- we must maintain sync get commands, check consistancy, and build new consistancy check check for turbo cheats killough 2/14/98, 2/20/98 -- only warn in netgames and demos cph - don't use sprintf, use doom_printf  killough 2/14/98 check for special buttons CPhipps - remote loadgame request Force if a netgame CPhipps - Restart the level CPhipps - Ignore in demos or old games cph - if the gamestate changed, we may need to clean up the old gamestate do main actions PLAYER STRUCTURE FUNCTIONS also see P_SpawnPlayer in P_Things G_PlayerFinishLevel Can when a player completes a level. cancel invisibility cancel gun flashes cancel ir gogles no palette changes CPhipps - G_SetPlayerColour Player colours stuff G_SetPlayerColour Rebuild colour translation tables accordingly Change translations on existing player mobj's G_PlayerReborn Called after a player dies almost everything is cleared and initialized killough 3/10/98,3/21/98: preserve cheats across idclev don't do anything immediately G_CheckSpot Returns false if the player cannot be respawned at the given mapthing_t spot because something is occupying it first spawn of level, before corpses killough 4/2/98: fix bug where P_CheckPosition() uses a non-solid corpse to detect collisions with other players in DM starts Old code: if (!P_CheckPosition (players[playernum].mo, x, y))    return false; flush an old corpse if needed killough 2/8/98: make corpse queue have an adjustable limit killough 8/1/98: Fix bugs causing strange crashes spawn a teleport fog Teleport fog at respawn point BUG: an can end up negative, because mthing->angle is (signed) short.
       * We have to emulate original Doom's behaviour, deferencing past the start
       * of the array, into the previous array (finetangent)  finecosine[-4096] finesine[-4096] finecosine[-3072] finesine[-3072] finecosine[-2048] finesine[-2048] finecosine[-1024] finesine[-1024] don't start sound on first frame G_DeathMatchSpawnPlayer Spawns a player at one of the random death match spots called at level load and each death no good spot, so the player will probably get stuck G_DoReborn reload the level from scratch respawn at the start first dissasociate the corpse spawn at random spot if in death match try to spawn at one of the other players spots fake as other player restore he's going to be inside something.  Too bad. DOOM Par Times DOOM II Par Times  1-10 11-20 21-30 31-32 Here's for the german edition. IF NO WOLF3D LEVELS, NO SECRET EXIT! G_DoCompleted take away cards and stuff kilough 2/7/98 cph - Remove ExM8 special case, so it gets summary screen displayed wminfo.next is 0 biased, unlike gamemap go to secret level returning from secret level go to next level cph - modified so that only whole seconds are added to the totalleveltimes
    *  value; so our total is compatible with the "naive" total of just adding
    *  the times in seconds shown for each level. Also means our total time
    *  will agree with Compet-n.
     G_WorldDone cph - after ExM8 summary screen, show victory stuffjff 3/17/98 allow new level's music to be loadedjff 4/12/98 clear any marks on the automap killough 2/28/98: A ridiculously large number of players, the most you'll ever need in a demo or savegame. This is used to prevent problems, in case more players in a game are supported later.CPhipps - savename variable redundant killough 12/98:
 * This function returns a signature for the current wad.
 * It is used to distinguish between wads, for the purposes
 * of savegame compatibility warnings, and options lookups.
  killough 5/15/98: add forced loadgames, which allow user to override checks CPhipps - net loadgames are always forced, so we only reach here  in single player killough 3/16/98: add slot info killough 5/15/98: add command-line CPhipps - handle savegame filename in G_DoLoadGame         - Delay load so it can be communicated in net game         - store info in special_event CPhipps - always force load netgames Do the old thing, immediate load killough 5/15/98: Consistency Error when attempting to load savegame. Need to fix, but right now we're ignoring a forced load Free the savegame buffer   M_ForcedLoadGame(msg);             // Print message asking for 'Y' to force If this was a command-line -loadgame Start the title screen And set the game state accordingly CPhipps - size of version header cph - we don't need a new version_header for prboom_3_comp/v2.1.1, since
                          *  the file format is unchanged.  CPhipps - do savegame filename stuff here killough 3/22/98 CPhipps - read the description field, compare with supported ones killough 2/22/98: "proprietary" version string :-) CPhipps - always check savegames even when forced,  only print a warning if forced killough 3/16/98: check lump name checksum (independent of order) cph - FIXME - compatibility flag?  killough 2/28/98 jff 3/17/98 restore idmus music jff 3/18/98 account for unsigned byte killough 3/1/98: Read game options
    * killough 11/98: move down to here
     load a base level get the times - killough 11/98: save entire word  cph - total episode time  killough 11/98: load revenant tracer state dearchive all the modifications killough 1/18/98: load RNG information killough 1/22/98: load automap information done draw the pattern into the back screen killough 12/98: support -recordfrom and -loadgame -playdemo  Clear singledemo flag if loading from menu  Mark that we're loading a game before demo  This will detect it and won't reinit level  Command line + record means it's a recordfrom  G_SaveGame Called by the menu task. Description is a 24 byte text string cph - We're doing a user-initiated save game while a demo is
       * running so, go outside normal mechanisms
        CPhipps - store info in special_event Check for overrun and realloc if necessary -- Lee Killough 1/22/98 breathing room killough 3/22/98: form savegame name in one location
 * (previously code was scattered around in multiple places)
 * cph - Avoid possible buffer overflow problems by passing
 * size to this function and using snprintf  cph - cancel savegame at top of this function, in case later problems cause a premature exit CPhipps - scan for the version header killough 2/22/98: "proprietary" version string :-) cph - free data killough 3/16/98, 12/98: store lump name checksum  killough 3/16/98: store pwad filenames in savegame CPhipps - changed for new wadfiles handling cph - FIXME? - Save compatibility level  killough 2/28/98 jff 3/17/98 save idmus state killough 3/1/98: save game options cph - FIXME - endianness?  killough 11/98: save entire word  cph - total episode time  killough 11/98: save revenant tracer state killough 3/22/98: add Z_CheckHeap after each call to ensure consistency phares 9/13/98: Move mobj_t->index out of P_ArchiveThinkers so the indices can be used by P_ArchiveWorld when the sectors are saved. This is so we can save the index of the mobj_t of the thinker that caused a sound, referenced by sector_t->soundtarget. phares 9/13/98: Move index->mobj_t out of P_ArchiveThinkers, simply for symmetry with the P_ThinkerToIndex call above. killough 1/18/98: save RNG information killough 1/22/98: save automap information consistancy marker Ty - externalised  CPhipps - not externalised killough ice & mud weapon recoil MT_PUSH Things whether player bobs or not cph -
 * G_Compatibility
 *
 * Initialises the comp[] array based on the compatibility_level
 * For reference, MBF did:
 * for (i=0; i < COMP_TOTAL; i++)
 *   comp[i] = compatibility;
 *
 * Instead, we have a lookup table showing at what version a fix was
 *  introduced.
  comp_telefrag - monsters used to telefrag only
              * on MAP30, now they do it for spawners only  comp_dropoff - MBF encourages things to drop
              * off of overhangs  comp_vile - original Doom archville bugs like
              * ghosts  comp_pain - original Doom limits Pain Elements
              * from spawning too many skulls  comp_skull - original Doom let skulls be spit
              * through walls by Pain Elementals  comp_blazing - original Doom duplicated
              * blazing door sound  comp_doorlight - MBF made door lighting changes
              * more gradual  comp_model - improvements to the game physics  comp_god - fixes to God mode  comp_falloff - MBF encourages things to drop
              * off of overhangs  comp_floors - fixes for moving floors bugs  comp_skymap  comp_pursuit - MBF AI change, limited pursuit?  comp_doorstuck - monsters stuck in doors fix  comp_staylift - MBF AI change, monsters try
              * to stay on lifts  comp_zombie - prevent dead players
                   * triggering stuff  comp_stairs - see p_floor.c  comp_infcheat - FIXME  comp_zerotags - allow zero tags in wads  comp_moveblock - enables keygrab and
                   * mancubi shots going thru walls  comp_respawn - objects which aren't on the map
                                     * at game start respawn at (0,0)  comp_sound - see s_sound.c  killough 7/19/98: Marine's best friend :)  killough 3/1/98: function to reload all the default parameter settings before a new game begins killough 3/1/98: Initialize options based on config file (allows functions above to load different values for demos and savegames without messing up defaults). weapon recoil whether player bobs or not remember former enemies killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 jff 1/24/98 reset play mode to command line spec'd version killough 3/1/98: moved to here   respawnparm = clrespawnparm;   fastparm = clfastparm;   nomonsters = clnomonsters;jff 3/24/98 set startskill from defaultskill in config file, unless it has already been set by a -skill parameter killough 9/29/98: don't stop after 1 demo killough 2/21/98: killough 3/31/98, 4/5/98: demo sync insurance CPhipps   rngseed += I_GetRandomTimeSeed() + gametic; // CPhipps killough 3/1/98 killough 3/1/98jff 4/26/98 wake up the status bar in case were coming out of a DM demo killough 4/10/98: New function to fix bug which caused Doom lockups when idclev was used in conjunction with -fast. remembers fast state only change if necessary  killough 4/10/98 don't change 1->0 since it causes cycles The sky texture to be used instead of the F_SKY1 dummy. G_InitNew Can be called by the startup code or the menu task, consoleplayer, displayplayer, playeringame[] should be set. only start episode 1 on shareware killough 4/10/98 force players to be initialized upon first level load will be set false if a demo cphjff 4/16/98 force marks on automap cleared every new level start DEMO RECORDING end of demo data stream Demo limits removed -- killough
 * cph - record straight to file
  cph - alias demo_p to it so we can read it back  make SURE it is exactly the same G_RecordDemo 1/18/98 killough cph - Record demos straight to file
    * If file already exists, try to continue existing demo
     sizeof(buf) is out of scope here  These functions are used to read and write game-specific options in demos and savegames so that demo sync is preserved and savegame restoration is complete. Not all options (for example "compatibility"), however, should be loaded and saved here. It is extremely important to use the same positions as before for the variables, so if one becomes obsolete, the byte(s) should still be skipped over or padded with 0's. Lee Killough 3/1/98 part of monster AI ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move around some in demos killough 3/31/98 killough 3/26/98: Added rngseed. 3/31/98: moved here Options new to v2.03 begin here killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98: a compatibility vector now cph 2002/07/20---------------- Padding at end---------------- Same, but read instead of write
 * cph - const byte*'s
  ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move from demo killough 3/31/98 killough 3/26/98: Added rngseed to demos; 3/31/98: moved here Options new to v2.03 killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98 killough 10/98: a compatibility vector now cph 2002/07/20 defaults for versions <= 2.02  cph - comp[] has already been set up right by G_Compatibility  killough 7/19/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 7/19/98 killough 10/98 cph - 3 demo record formats supported: MBF+, BOOM, and Doom v1.9  Write version code into demo  signature killough 2/22/98: save compatibility flag in new demos
       * cph - FIXME? MBF demos will always be not in compat. mode  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility Nominally, version and compatibility bits  signature CPhipps - save compatibility level in demos  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility cph - write old v1.9 demos (might even sync) v1.9 has best chance of syncing these intentionally hard-coded 4 -- killough G_PlayDemo killough 9/29/98 killough 2/22/98, 2/28/98: autodetect old demos and act accordingly. Old demos turn on demo_compatibility => compatibility; new demos load compatibility flag, and other flags as well, as a part of the demo. Autodetect old demos killough 3/2/98: force these variables to be 0 in demo_compatibility killough 7/19/98 killough 7/19/98 killough 10/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 3/6/98: rearrange to fix savegame bugs (moved fastparm, respawnparm, nomonsters flags to G_LoadOptions()/G_SaveOptions()) For demos from versions >= 1.4 new versions of demos skip signature; BOOM  LxDoom or MBF - determine from signature
          * cph - load compatibility level  LxDoom  cph - DEMOSYNC - LxDoom demos recorded in compatibility modes support dropped  killough 3/1/98: Read game options killough 6/3/98: partially fix v2.00 demos   printf( "G_DoPlayDemo: playing demo with %s compatibility\n",           comp_lev_str[compatibility_level]); only 4 players can exist in old demos intentionally hard-coded 4 -- killough killough 12/98: support -loadgame  killough 4/24/98 killough cph - store lump number for unlocking later  G_TimeDemo CPhipps - const char* G_CheckDemoStatus
 *
 * Called after a death or level completion to allow demos to be cleaned up
 * Returns true if a new demo loop action will take place
  killough      int endtime = I_GetTime_RealTime (); killough -- added fps information and made it work for longer demos:         exit(0);  // killough cph - unlock the demo lump killough 3/1/98 killough 3/29/98 killough 1/22/98: this is a "Doom printf" for messages. I've gotten tired of using players->message=... and so I've added this dprintf. killough 3/6/98: Made limit static to allow z_zone functions to call this function, without calling realloc(), which seems to cause problems. CPhipps - renamed to doom_printf to avoid name collision with glibc print message in buffer  set new message Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:  none
 *  The original Doom description was none, basically because this file
 *  has everything. This ties up the game logic, linking the menu and
 *  input code to the underlying game by creating & respawning players,
 *  building game tics, calling the underlying thing logic.
 *
 *-----------------------------------------------------------------------------
  Needs access to LFB. Data. SKY handling - still the wrong place. killough cph - only used for playback  cph - record straight to file  CPhipps - moved *_loadgame vars here ok to save / end game if true, exit with report on completion if true, run at full speed -- killough for comparative timing purposes for comparative timing purposes for comparative timing purposes only if started as net death only true if packets are broadcast player taking events and displaying view being displayed gametic at level start killough 9/29/98: for demo sync  for intermission quit after playing a demo from cmdline parms for world map / intermission jff 4/18/98 wolf levels present CPhipps - static always running?          // phares CPhipps - total time for all completed levels controls (have defaults) phares 3/7/98     |     V     ^     | phares 3/7/98 phares 4/13/98 phares    |    V cph - map overlay cph - map rotation phares 4/13/98    ^    | phares killough 2/22/98: screenshot key 180 degree reverse                    // phares + slow turn CPhipps - made lots of key/button state vars static for accelerative turning allow [-1] mouse values are used once scrollwheel values joystick values are repeated allow [-1] Game events info Event triggered by local player, to send Slot to load if gameaction == ga_loadgame Description to save in savegame if gameaction == ga_savegamejff 3/24/98 declare startskill external, define defaultskill herenote 0-basednote 1-based killough 2/8/98: make corpse queue variable in size killough 2/8/98 phares 8/10/98 for statistics driver G_BuildTiccmd Builds a ticcmd from all of the available inputs or reads it from the demo buffer. If recording a demo, write it out phares cphipps - remove needless I_BaseTiccmd call, just set the ticcmd to zero  phares use two stage accelerative turning on the keyboard and joystick slow turn turn 180 degrees in one keystroke?                           // phares    |    V    ^    | phares let movement keys cancel each other out strafe with scrollwheel  buttons clear double clicks if hit use button Toggle between the top 2 favorite weapons.                   // phares If not currently aiming one of these, switch to              // phares the favorite. Only switch if you possess the weapon.         // phares killough 3/22/98: Perform automatic weapons switch here rather than in p_pspr.c, except in demo_compatibility mode. killough 3/26/98, 4/2/98: fix autoswitch when no weapons are left killough phares phares 02/26/98: Added gamemode checks I don't know why this is needed, but it is killough 5/2/98: reformatted killough 3/22/98: For network and demo consistency with the new weapons preferences, we must do the weapons switches here instead of in p_user.c. But for old demos we must do it in p_user.c according to the old rules. Therefore demo_compatibility determines where the weapons switch is made. killough 2/8/98: Allow user to switch to fist even if they have chainsaw. Switch to fist or chainsaw based on preferences. Switch to shotgun or SSG based on preferences. only select chainsaw from '1' if it's owned, it's not already in use, and the player prefers it or the fist is already in use, or the player does not have the berserker strength. Select SSG from '3' only if it's owned and the player does not have a shotgun, or if the shotgun is already in use, or if the SSG is not already in use and the player prefers it. killough 2/8/98, 3/22/98 -- end of weapon selection changes something is messed up with the weapon switching code above allowing it to give values greater then wp_nochange which really screws the game up mouse forward double click strafe double click mead  Don't want to strafe as fast as turns. mead now have enough dynamic range 2-10-00  CPhipps - special events (game new/load/save/pause) G_RestartLevel G_DoLoadLevel Set the sky map. First thing, we have a dummy sky texture name,  a flat. The data is in the WAD only because  we look for an actual index, instead of simply  setting one. DOOM determines the sky texture to be used depending on the current episode, and the game version. || gamemode == pack_tnt   //jff 3/27/98 sorry guys pack_tnt,pack_plut || gamemode == pack_plut) //aren't gamemodes, this was matching retailjff 3/27/98 and lets not forget about DOOM and Ultimate DOOM huh? Special Edition skyjff 3/27/98 end sky setting fix for time calculation killough 9/29/98 force a wipe initialize the msecnode_t freelist.                     phares 3/25/98 any nodes in the freelist are gone by now, cleared by Z_FreeTags() when the previous level ended or player died.extern msecnode_t *headsecnode; // phares 3/25/98headsecnode = NULL; view the guy you are playing clear cmd building stuff killough 5/13/98: in case netdemo has consoleplayer other than green killough: make -timedemo work on multilevel demos Move to end of function to minimize noise -- killough 2/22/98: G_Responder Get info needed to make ticcmd_ts for the players. allow spy mode changes even during the demo killough 2/22/98: even during DM demo killough 11/98: don't autorepeat spy mode switch spy mode killough 3/7/98: switch status bar views too any other key pops up menu if in demos killough 8/2/98: enable automap in -timedemo demos killough 9/29/98: make any key pop up menu regardless of which kind of demo, and allow other events during playback killough 9/29/98: allow user to pause demos during playback killough 10/98: Don't pop up menu, if paused in middle of demo playback, or if automap active. Don't suck up keys, which may be cheats finale ate the event phares eat key down events always let key up events filter down eat events eat events G_Ticker Make ticcmd_ts for the players. do player reborns if needed do things to change the game state force players to be initialized on level reload For revenant tracers and RNG -- we must maintain sync get commands, check consistancy, and build new consistancy check check for turbo cheats killough 2/14/98, 2/20/98 -- only warn in netgames and demos cph - don't use sprintf, use doom_printf  killough 2/14/98 check for special buttons CPhipps - remote loadgame request Force if a netgame CPhipps - Restart the level CPhipps - Ignore in demos or old games cph - if the gamestate changed, we may need to clean up the old gamestate do main actions PLAYER STRUCTURE FUNCTIONS also see P_SpawnPlayer in P_Things G_PlayerFinishLevel Can when a player completes a level. cancel invisibility cancel gun flashes cancel ir gogles no palette changes CPhipps - G_SetPlayerColour Player colours stuff G_SetPlayerColour Rebuild colour translation tables accordingly Change translations on existing player mobj's G_PlayerReborn Called after a player dies almost everything is cleared and initialized killough 3/10/98,3/21/98: preserve cheats across idclev don't do anything immediately G_CheckSpot Returns false if the player cannot be respawned at the given mapthing_t spot because something is occupying it first spawn of level, before corpses killough 4/2/98: fix bug where P_CheckPosition() uses a non-solid corpse to detect collisions with other players in DM starts Old code: if (!P_CheckPosition (players[playernum].mo, x, y))    return false; flush an old corpse if needed killough 2/8/98: make corpse queue have an adjustable limit killough 8/1/98: Fix bugs causing strange crashes spawn a teleport fog Teleport fog at respawn point BUG: an can end up negative, because mthing->angle is (signed) short.
       * We have to emulate original Doom's behaviour, deferencing past the start
       * of the array, into the previous array (finetangent)  finecosine[-4096] finesine[-4096] finecosine[-3072] finesine[-3072] finecosine[-2048] finesine[-2048] finecosine[-1024] finesine[-1024] don't start sound on first frame G_DeathMatchSpawnPlayer Spawns a player at one of the random death match spots called at level load and each death no good spot, so the player will probably get stuck G_DoReborn reload the level from scratch respawn at the start first dissasociate the corpse spawn at random spot if in death match try to spawn at one of the other players spots fake as other player restore he's going to be inside something.  Too bad. DOOM Par Times DOOM II Par Times  1-10 11-20 21-30 31-32 Here's for the german edition. IF NO WOLF3D LEVELS, NO SECRET EXIT! G_DoCompleted take away cards and stuff kilough 2/7/98 cph - Remove ExM8 special case, so it gets summary screen displayed wminfo.next is 0 biased, unlike gamemap go to secret level returning from secret level go to next level cph - modified so that only whole seconds are added to the totalleveltimes
    *  value; so our total is compatible with the "naive" total of just adding
    *  the times in seconds shown for each level. Also means our total time
    *  will agree with Compet-n.
     G_WorldDone cph - after ExM8 summary screen, show victory stuffjff 3/17/98 allow new level's music to be loadedjff 4/12/98 clear any marks on the automap killough 2/28/98: A ridiculously large number of players, the most you'll ever need in a demo or savegame. This is used to prevent problems, in case more players in a game are supported later.CPhipps - savename variable redundant killough 12/98:
 * This function returns a signature for the current wad.
 * It is used to distinguish between wads, for the purposes
 * of savegame compatibility warnings, and options lookups.
  killough 5/15/98: add forced loadgames, which allow user to override checks CPhipps - net loadgames are always forced, so we only reach here  in single player killough 3/16/98: add slot info killough 5/15/98: add command-line CPhipps - handle savegame filename in G_DoLoadGame         - Delay load so it can be communicated in net game         - store info in special_event CPhipps - always force load netgames Do the old thing, immediate load killough 5/15/98: Consistency Error when attempting to load savegame. Need to fix, but right now we're ignoring a forced load Free the savegame buffer   M_ForcedLoadGame(msg);             // Print message asking for 'Y' to force If this was a command-line -loadgame Start the title screen And set the game state accordingly CPhipps - size of version header cph - we don't need a new version_header for prboom_3_comp/v2.1.1, since
                          *  the file format is unchanged.  CPhipps - do savegame filename stuff here killough 3/22/98 CPhipps - read the description field, compare with supported ones killough 2/22/98: "proprietary" version string :-) CPhipps - always check savegames even when forced,  only print a warning if forced killough 3/16/98: check lump name checksum (independent of order) cph - FIXME - compatibility flag?  killough 2/28/98 jff 3/17/98 restore idmus music jff 3/18/98 account for unsigned byte killough 3/1/98: Read game options
    * killough 11/98: move down to here
     load a base level get the times - killough 11/98: save entire word  cph - total episode time  killough 11/98: load revenant tracer state dearchive all the modifications killough 1/18/98: load RNG information killough 1/22/98: load automap information done draw the pattern into the back screen killough 12/98: support -recordfrom and -loadgame -playdemo  Clear singledemo flag if loading from menu  Mark that we're loading a game before demo  This will detect it and won't reinit level  Command line + record means it's a recordfrom  G_SaveGame Called by the menu task. Description is a 24 byte text string cph - We're doing a user-initiated save game while a demo is
       * running so, go outside normal mechanisms
        CPhipps - store info in special_event Check for overrun and realloc if necessary -- Lee Killough 1/22/98 breathing room killough 3/22/98: form savegame name in one location
 * (previously code was scattered around in multiple places)
 * cph - Avoid possible buffer overflow problems by passing
 * size to this function and using snprintf  cph - cancel savegame at top of this function, in case later problems cause a premature exit CPhipps - scan for the version header killough 2/22/98: "proprietary" version string :-) cph - free data killough 3/16/98, 12/98: store lump name checksum  killough 3/16/98: store pwad filenames in savegame CPhipps - changed for new wadfiles handling cph - FIXME? - Save compatibility level  killough 2/28/98 jff 3/17/98 save idmus state killough 3/1/98: save game options cph - FIXME - endianness?  killough 11/98: save entire word  cph - total episode time  killough 11/98: save revenant tracer state killough 3/22/98: add Z_CheckHeap after each call to ensure consistency phares 9/13/98: Move mobj_t->index out of P_ArchiveThinkers so the indices can be used by P_ArchiveWorld when the sectors are saved. This is so we can save the index of the mobj_t of the thinker that caused a sound, referenced by sector_t->soundtarget. phares 9/13/98: Move index->mobj_t out of P_ArchiveThinkers, simply for symmetry with the P_ThinkerToIndex call above. killough 1/18/98: save RNG information killough 1/22/98: save automap information consistancy marker Ty - externalised  CPhipps - not externalised killough ice & mud weapon recoil MT_PUSH Things whether player bobs or not cph -
 * G_Compatibility
 *
 * Initialises the comp[] array based on the compatibility_level
 * For reference, MBF did:
 * for (i=0; i < COMP_TOTAL; i++)
 *   comp[i] = compatibility;
 *
 * Instead, we have a lookup table showing at what version a fix was
 *  introduced.
  comp_telefrag - monsters used to telefrag only
              * on MAP30, now they do it for spawners only  comp_dropoff - MBF encourages things to drop
              * off of overhangs  comp_vile - original Doom archville bugs like
              * ghosts  comp_pain - original Doom limits Pain Elements
              * from spawning too many skulls  comp_skull - original Doom let skulls be spit
              * through walls by Pain Elementals  comp_blazing - original Doom duplicated
              * blazing door sound  comp_doorlight - MBF made door lighting changes
              * more gradual  comp_model - improvements to the game physics  comp_god - fixes to God mode  comp_falloff - MBF encourages things to drop
              * off of overhangs  comp_floors - fixes for moving floors bugs  comp_skymap  comp_pursuit - MBF AI change, limited pursuit?  comp_doorstuck - monsters stuck in doors fix  comp_staylift - MBF AI change, monsters try
              * to stay on lifts  comp_zombie - prevent dead players
                   * triggering stuff  comp_stairs - see p_floor.c  comp_infcheat - FIXME  comp_zerotags - allow zero tags in wads  comp_moveblock - enables keygrab and
                   * mancubi shots going thru walls  comp_respawn - objects which aren't on the map
                                     * at game start respawn at (0,0)  comp_sound - see s_sound.c  killough 7/19/98: Marine's best friend :)  killough 3/1/98: function to reload all the default parameter settings before a new game begins killough 3/1/98: Initialize options based on config file (allows functions above to load different values for demos and savegames without messing up defaults). weapon recoil whether player bobs or not remember former enemies killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 jff 1/24/98 reset play mode to command line spec'd version killough 3/1/98: moved to here   respawnparm = clrespawnparm;   fastparm = clfastparm;   nomonsters = clnomonsters;jff 3/24/98 set startskill from defaultskill in config file, unless it has already been set by a -skill parameter killough 9/29/98: don't stop after 1 demo killough 2/21/98: killough 3/31/98, 4/5/98: demo sync insurance CPhipps   rngseed += I_GetRandomTimeSeed() + gametic; // CPhipps killough 3/1/98 killough 3/1/98jff 4/26/98 wake up the status bar in case were coming out of a DM demo killough 4/10/98: New function to fix bug which caused Doom lockups when idclev was used in conjunction with -fast. remembers fast state only change if necessary  killough 4/10/98 don't change 1->0 since it causes cycles The sky texture to be used instead of the F_SKY1 dummy. G_InitNew Can be called by the startup code or the menu task, consoleplayer, displayplayer, playeringame[] should be set. only start episode 1 on shareware killough 4/10/98 force players to be initialized upon first level load will be set false if a demo cphjff 4/16/98 force marks on automap cleared every new level start DEMO RECORDING end of demo data stream Demo limits removed -- killough
 * cph - record straight to file
  cph - alias demo_p to it so we can read it back  make SURE it is exactly the same G_RecordDemo 1/18/98 killough cph - Record demos straight to file
    * If file already exists, try to continue existing demo
     sizeof(buf) is out of scope here  These functions are used to read and write game-specific options in demos and savegames so that demo sync is preserved and savegame restoration is complete. Not all options (for example "compatibility"), however, should be loaded and saved here. It is extremely important to use the same positions as before for the variables, so if one becomes obsolete, the byte(s) should still be skipped over or padded with 0's. Lee Killough 3/1/98 part of monster AI ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move around some in demos killough 3/31/98 killough 3/26/98: Added rngseed. 3/31/98: moved here Options new to v2.03 begin here killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98: a compatibility vector now cph 2002/07/20---------------- Padding at end---------------- Same, but read instead of write
 * cph - const byte*'s
  ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move from demo killough 3/31/98 killough 3/26/98: Added rngseed to demos; 3/31/98: moved here Options new to v2.03 killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98 killough 10/98: a compatibility vector now cph 2002/07/20 defaults for versions <= 2.02  cph - comp[] has already been set up right by G_Compatibility  killough 7/19/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 7/19/98 killough 10/98 cph - 3 demo record formats supported: MBF+, BOOM, and Doom v1.9  Write version code into demo  signature killough 2/22/98: save compatibility flag in new demos
       * cph - FIXME? MBF demos will always be not in compat. mode  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility Nominally, version and compatibility bits  signature CPhipps - save compatibility level in demos  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility cph - write old v1.9 demos (might even sync) v1.9 has best chance of syncing these intentionally hard-coded 4 -- killough G_PlayDemo killough 9/29/98 killough 2/22/98, 2/28/98: autodetect old demos and act accordingly. Old demos turn on demo_compatibility => compatibility; new demos load compatibility flag, and other flags as well, as a part of the demo. Autodetect old demos killough 3/2/98: force these variables to be 0 in demo_compatibility killough 7/19/98 killough 7/19/98 killough 10/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 3/6/98: rearrange to fix savegame bugs (moved fastparm, respawnparm, nomonsters flags to G_LoadOptions()/G_SaveOptions()) For demos from versions >= 1.4 new versions of demos skip signature; BOOM  LxDoom or MBF - determine from signature
          * cph - load compatibility level  LxDoom  cph - DEMOSYNC - LxDoom demos recorded in compatibility modes support dropped  killough 3/1/98: Read game options killough 6/3/98: partially fix v2.00 demos   printf( "G_DoPlayDemo: playing demo with %s compatibility\n",           comp_lev_str[compatibility_level]); only 4 players can exist in old demos intentionally hard-coded 4 -- killough killough 12/98: support -loadgame  killough 4/24/98 killough cph - store lump number for unlocking later  G_TimeDemo CPhipps - const char* G_CheckDemoStatus
 *
 * Called after a death or level completion to allow demos to be cleaned up
 * Returns true if a new demo loop action will take place
  killough      int endtime = I_GetTime_RealTime (); killough -- added fps information and made it work for longer demos:         exit(0);  // killough cph - unlock the demo lump killough 3/1/98 killough 3/29/98 killough 1/22/98: this is a "Doom printf" for messages. I've gotten tired of using players->message=... and so I've added this dprintf. killough 3/6/98: Made limit static to allow z_zone functions to call this function, without calling realloc(), which seems to cause problems. CPhipps - renamed to doom_printf to avoid name collision with glibc print message in buffer  set new message Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:  none
 *  The original Doom description was none, basically because this file
 *  has everything. This ties up the game logic, linking the menu and
 *  input code to the underlying game by creating & respawning players,
 *  building game tics, calling the underlying thing logic.
 *
 *-----------------------------------------------------------------------------
  Needs access to LFB. Data. SKY handling - still the wrong place. killough cph - only used for playback  cph - record straight to file  CPhipps - moved *_loadgame vars here ok to save / end game if true, exit with report on completion if true, run at full speed -- killough for comparative timing purposes for comparative timing purposes for comparative timing purposes only if started as net death only true if packets are broadcast player taking events and displaying view being displayed gametic at level start killough 9/29/98: for demo sync  for intermission quit after playing a demo from cmdline parms for world map / intermission jff 4/18/98 wolf levels present CPhipps - static always running?          // phares CPhipps - total time for all completed levels controls (have defaults) phares 3/7/98     |     V     ^     | phares 3/7/98 phares 4/13/98 phares    |    V cph - map overlay cph - map rotation phares 4/13/98    ^    | phares killough 2/22/98: screenshot key 180 degree reverse                    // phares + slow turn CPhipps - made lots of key/button state vars static for accelerative turning allow [-1] mouse values are used once scrollwheel values joystick values are repeated allow [-1] Game events info Event triggered by local player, to send Slot to load if gameaction == ga_loadgame Description to save in savegame if gameaction == ga_savegamejff 3/24/98 declare startskill external, define defaultskill herenote 0-basednote 1-based killough 2/8/98: make corpse queue variable in size killough 2/8/98 phares 8/10/98 for statistics driver G_BuildTiccmd Builds a ticcmd from all of the available inputs or reads it from the demo buffer. If recording a demo, write it out phares cphipps - remove needless I_BaseTiccmd call, just set the ticcmd to zero  phares use two stage accelerative turning on the keyboard and joystick slow turn turn 180 degrees in one keystroke?                           // phares    |    V    ^    | phares let movement keys cancel each other out strafe with scrollwheel  buttons clear double clicks if hit use button Toggle between the top 2 favorite weapons.                   // phares If not currently aiming one of these, switch to              // phares the favorite. Only switch if you possess the weapon.         // phares killough 3/22/98: Perform automatic weapons switch here rather than in p_pspr.c, except in demo_compatibility mode. killough 3/26/98, 4/2/98: fix autoswitch when no weapons are left killough phares phares 02/26/98: Added gamemode checks I don't know why this is needed, but it is killough 5/2/98: reformatted killough 3/22/98: For network and demo consistency with the new weapons preferences, we must do the weapons switches here instead of in p_user.c. But for old demos we must do it in p_user.c according to the old rules. Therefore demo_compatibility determines where the weapons switch is made. killough 2/8/98: Allow user to switch to fist even if they have chainsaw. Switch to fist or chainsaw based on preferences. Switch to shotgun or SSG based on preferences. only select chainsaw from '1' if it's owned, it's not already in use, and the player prefers it or the fist is already in use, or the player does not have the berserker strength. Select SSG from '3' only if it's owned and the player does not have a shotgun, or if the shotgun is already in use, or if the SSG is not already in use and the player prefers it. killough 2/8/98, 3/22/98 -- end of weapon selection changes something is messed up with the weapon switching code above allowing it to give values greater then wp_nochange which really screws the game up mouse forward double click strafe double click mead  Don't want to strafe as fast as turns. mead now have enough dynamic range 2-10-00  CPhipps - special events (game new/load/save/pause) G_RestartLevel G_DoLoadLevel Set the sky map. First thing, we have a dummy sky texture name,  a flat. The data is in the WAD only because  we look for an actual index, instead of simply  setting one. DOOM determines the sky texture to be used depending on the current episode, and the game version. || gamemode == pack_tnt   //jff 3/27/98 sorry guys pack_tnt,pack_plut || gamemode == pack_plut) //aren't gamemodes, this was matching retailjff 3/27/98 and lets not forget about DOOM and Ultimate DOOM huh? Special Edition skyjff 3/27/98 end sky setting fix for time calculation killough 9/29/98 force a wipe initialize the msecnode_t freelist.                     phares 3/25/98 any nodes in the freelist are gone by now, cleared by Z_FreeTags() when the previous level ended or player died.extern msecnode_t *headsecnode; // phares 3/25/98headsecnode = NULL; view the guy you are playing clear cmd building stuff killough 5/13/98: in case netdemo has consoleplayer other than green killough: make -timedemo work on multilevel demos Move to end of function to minimize noise -- killough 2/22/98: G_Responder Get info needed to make ticcmd_ts for the players. allow spy mode changes even during the demo killough 2/22/98: even during DM demo killough 11/98: don't autorepeat spy mode switch spy mode killough 3/7/98: switch status bar views too any other key pops up menu if in demos killough 8/2/98: enable automap in -timedemo demos killough 9/29/98: make any key pop up menu regardless of which kind of demo, and allow other events during playback killough 9/29/98: allow user to pause demos during playback killough 10/98: Don't pop up menu, if paused in middle of demo playback, or if automap active. Don't suck up keys, which may be cheats finale ate the event phares eat key down events always let key up events filter down eat events eat events G_Ticker Make ticcmd_ts for the players. do player reborns if needed do things to change the game state force players to be initialized on level reload For revenant tracers and RNG -- we must maintain sync get commands, check consistancy, and build new consistancy check check for turbo cheats killough 2/14/98, 2/20/98 -- only warn in netgames and demos cph - don't use sprintf, use doom_printf  killough 2/14/98 check for special buttons CPhipps - remote loadgame request Force if a netgame CPhipps - Restart the level CPhipps - Ignore in demos or old games cph - if the gamestate changed, we may need to clean up the old gamestate do main actions PLAYER STRUCTURE FUNCTIONS also see P_SpawnPlayer in P_Things G_PlayerFinishLevel Can when a player completes a level. cancel invisibility cancel gun flashes cancel ir gogles no palette changes CPhipps - G_SetPlayerColour Player colours stuff G_SetPlayerColour Rebuild colour translation tables accordingly Change translations on existing player mobj's G_PlayerReborn Called after a player dies almost everything is cleared and initialized killough 3/10/98,3/21/98: preserve cheats across idclev don't do anything immediately G_CheckSpot Returns false if the player cannot be respawned at the given mapthing_t spot because something is occupying it first spawn of level, before corpses killough 4/2/98: fix bug where P_CheckPosition() uses a non-solid corpse to detect collisions with other players in DM starts Old code: if (!P_CheckPosition (players[playernum].mo, x, y))    return false; flush an old corpse if needed killough 2/8/98: make corpse queue have an adjustable limit killough 8/1/98: Fix bugs causing strange crashes spawn a teleport fog Teleport fog at respawn point BUG: an can end up negative, because mthing->angle is (signed) short.
       * We have to emulate original Doom's behaviour, deferencing past the start
       * of the array, into the previous array (finetangent)  finecosine[-4096] finesine[-4096] finecosine[-3072] finesine[-3072] finecosine[-2048] finesine[-2048] finecosine[-1024] finesine[-1024] don't start sound on first frame G_DeathMatchSpawnPlayer Spawns a player at one of the random death match spots called at level load and each death no good spot, so the player will probably get stuck G_DoReborn reload the level from scratch respawn at the start first dissasociate the corpse spawn at random spot if in death match try to spawn at one of the other players spots fake as other player restore he's going to be inside something.  Too bad. DOOM Par Times DOOM II Par Times  1-10 11-20 21-30 31-32 Here's for the german edition. IF NO WOLF3D LEVELS, NO SECRET EXIT! G_DoCompleted take away cards and stuff kilough 2/7/98 cph - Remove ExM8 special case, so it gets summary screen displayed wminfo.next is 0 biased, unlike gamemap go to secret level returning from secret level go to next level cph - modified so that only whole seconds are added to the totalleveltimes
    *  value; so our total is compatible with the "naive" total of just adding
    *  the times in seconds shown for each level. Also means our total time
    *  will agree with Compet-n.
     G_WorldDone cph - after ExM8 summary screen, show victory stuffjff 3/17/98 allow new level's music to be loadedjff 4/12/98 clear any marks on the automap killough 2/28/98: A ridiculously large number of players, the most you'll ever need in a demo or savegame. This is used to prevent problems, in case more players in a game are supported later.CPhipps - savename variable redundant killough 12/98:
 * This function returns a signature for the current wad.
 * It is used to distinguish between wads, for the purposes
 * of savegame compatibility warnings, and options lookups.
  killough 5/15/98: add forced loadgames, which allow user to override checks CPhipps - net loadgames are always forced, so we only reach here  in single player killough 3/16/98: add slot info killough 5/15/98: add command-line CPhipps - handle savegame filename in G_DoLoadGame         - Delay load so it can be communicated in net game         - store info in special_event CPhipps - always force load netgames Do the old thing, immediate load killough 5/15/98: Consistency Error when attempting to load savegame. Need to fix, but right now we're ignoring a forced load Free the savegame buffer   M_ForcedLoadGame(msg);             // Print message asking for 'Y' to force If this was a command-line -loadgame Start the title screen And set the game state accordingly CPhipps - size of version header cph - we don't need a new version_header for prboom_3_comp/v2.1.1, since
                          *  the file format is unchanged.  CPhipps - do savegame filename stuff here killough 3/22/98 CPhipps - read the description field, compare with supported ones killough 2/22/98: "proprietary" version string :-) CPhipps - always check savegames even when forced,  only print a warning if forced killough 3/16/98: check lump name checksum (independent of order) cph - FIXME - compatibility flag?  killough 2/28/98 jff 3/17/98 restore idmus music jff 3/18/98 account for unsigned byte killough 3/1/98: Read game options
    * killough 11/98: move down to here
     load a base level get the times - killough 11/98: save entire word  cph - total episode time  killough 11/98: load revenant tracer state dearchive all the modifications killough 1/18/98: load RNG information killough 1/22/98: load automap information done draw the pattern into the back screen killough 12/98: support -recordfrom and -loadgame -playdemo  Clear singledemo flag if loading from menu  Mark that we're loading a game before demo  This will detect it and won't reinit level  Command line + record means it's a recordfrom  G_SaveGame Called by the menu task. Description is a 24 byte text string cph - We're doing a user-initiated save game while a demo is
       * running so, go outside normal mechanisms
        CPhipps - store info in special_event Check for overrun and realloc if necessary -- Lee Killough 1/22/98 breathing room killough 3/22/98: form savegame name in one location
 * (previously code was scattered around in multiple places)
 * cph - Avoid possible buffer overflow problems by passing
 * size to this function and using snprintf  cph - cancel savegame at top of this function, in case later problems cause a premature exit CPhipps - scan for the version header killough 2/22/98: "proprietary" version string :-) cph - free data killough 3/16/98, 12/98: store lump name checksum  killough 3/16/98: store pwad filenames in savegame CPhipps - changed for new wadfiles handling cph - FIXME? - Save compatibility level  killough 2/28/98 jff 3/17/98 save idmus state killough 3/1/98: save game options cph - FIXME - endianness?  killough 11/98: save entire word  cph - total episode time  killough 11/98: save revenant tracer state killough 3/22/98: add Z_CheckHeap after each call to ensure consistency phares 9/13/98: Move mobj_t->index out of P_ArchiveThinkers so the indices can be used by P_ArchiveWorld when the sectors are saved. This is so we can save the index of the mobj_t of the thinker that caused a sound, referenced by sector_t->soundtarget. phares 9/13/98: Move index->mobj_t out of P_ArchiveThinkers, simply for symmetry with the P_ThinkerToIndex call above. killough 1/18/98: save RNG information killough 1/22/98: save automap information consistancy marker Ty - externalised  CPhipps - not externalised killough ice & mud weapon recoil MT_PUSH Things whether player bobs or not cph -
 * G_Compatibility
 *
 * Initialises the comp[] array based on the compatibility_level
 * For reference, MBF did:
 * for (i=0; i < COMP_TOTAL; i++)
 *   comp[i] = compatibility;
 *
 * Instead, we have a lookup table showing at what version a fix was
 *  introduced.
  comp_telefrag - monsters used to telefrag only
              * on MAP30, now they do it for spawners only  comp_dropoff - MBF encourages things to drop
              * off of overhangs  comp_vile - original Doom archville bugs like
              * ghosts  comp_pain - original Doom limits Pain Elements
              * from spawning too many skulls  comp_skull - original Doom let skulls be spit
              * through walls by Pain Elementals  comp_blazing - original Doom duplicated
              * blazing door sound  comp_doorlight - MBF made door lighting changes
              * more gradual  comp_model - improvements to the game physics  comp_god - fixes to God mode  comp_falloff - MBF encourages things to drop
              * off of overhangs  comp_floors - fixes for moving floors bugs  comp_skymap  comp_pursuit - MBF AI change, limited pursuit?  comp_doorstuck - monsters stuck in doors fix  comp_staylift - MBF AI change, monsters try
              * to stay on lifts  comp_zombie - prevent dead players
                   * triggering stuff  comp_stairs - see p_floor.c  comp_infcheat - FIXME  comp_zerotags - allow zero tags in wads  comp_moveblock - enables keygrab and
                   * mancubi shots going thru walls  comp_respawn - objects which aren't on the map
                                     * at game start respawn at (0,0)  comp_sound - see s_sound.c  killough 7/19/98: Marine's best friend :)  killough 3/1/98: function to reload all the default parameter settings before a new game begins killough 3/1/98: Initialize options based on config file (allows functions above to load different values for demos and savegames without messing up defaults). weapon recoil whether player bobs or not remember former enemies killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 jff 1/24/98 reset play mode to command line spec'd version killough 3/1/98: moved to here   respawnparm = clrespawnparm;   fastparm = clfastparm;   nomonsters = clnomonsters;jff 3/24/98 set startskill from defaultskill in config file, unless it has already been set by a -skill parameter killough 9/29/98: don't stop after 1 demo killough 2/21/98: killough 3/31/98, 4/5/98: demo sync insurance CPhipps   rngseed += I_GetRandomTimeSeed() + gametic; // CPhipps killough 3/1/98 killough 3/1/98jff 4/26/98 wake up the status bar in case were coming out of a DM demo killough 4/10/98: New function to fix bug which caused Doom lockups when idclev was used in conjunction with -fast. remembers fast state only change if necessary  killough 4/10/98 don't change 1->0 since it causes cycles The sky texture to be used instead of the F_SKY1 dummy. G_InitNew Can be called by the startup code or the menu task, consoleplayer, displayplayer, playeringame[] should be set. only start episode 1 on shareware killough 4/10/98 force players to be initialized upon first level load will be set false if a demo cphjff 4/16/98 force marks on automap cleared every new level start DEMO RECORDING end of demo data stream Demo limits removed -- killough
 * cph - record straight to file
  cph - alias demo_p to it so we can read it back  make SURE it is exactly the same G_RecordDemo 1/18/98 killough cph - Record demos straight to file
    * If file already exists, try to continue existing demo
     sizeof(buf) is out of scope here  These functions are used to read and write game-specific options in demos and savegames so that demo sync is preserved and savegame restoration is complete. Not all options (for example "compatibility"), however, should be loaded and saved here. It is extremely important to use the same positions as before for the variables, so if one becomes obsolete, the byte(s) should still be skipped over or padded with 0's. Lee Killough 3/1/98 part of monster AI ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move around some in demos killough 3/31/98 killough 3/26/98: Added rngseed. 3/31/98: moved here Options new to v2.03 begin here killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98: a compatibility vector now cph 2002/07/20---------------- Padding at end---------------- Same, but read instead of write
 * cph - const byte*'s
  ice & mud weapon recoil MT_PUSH Things whether player bobs or not killough 3/6/98: add parameters to savegame, move from demo killough 3/31/98 killough 3/26/98: Added rngseed to demos; 3/31/98: moved here Options new to v2.03 killough 7/19/98 killough 7/19/98 killough 8/8/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 10/98 killough 10/98: a compatibility vector now cph 2002/07/20 defaults for versions <= 2.02  cph - comp[] has already been set up right by G_Compatibility  killough 7/19/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 7/19/98 killough 10/98 cph - 3 demo record formats supported: MBF+, BOOM, and Doom v1.9  Write version code into demo  signature killough 2/22/98: save compatibility flag in new demos
       * cph - FIXME? MBF demos will always be not in compat. mode  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility Nominally, version and compatibility bits  signature CPhipps - save compatibility level in demos  killough 3/1/98: Save game options killough 2/28/98: We always store at least MIN_MAXPLAYERS bytes in demo, to support enhancements later w/o losing demo compatibility cph - write old v1.9 demos (might even sync) v1.9 has best chance of syncing these intentionally hard-coded 4 -- killough G_PlayDemo killough 9/29/98 killough 2/22/98, 2/28/98: autodetect old demos and act accordingly. Old demos turn on demo_compatibility => compatibility; new demos load compatibility flag, and other flags as well, as a part of the demo. Autodetect old demos killough 3/2/98: force these variables to be 0 in demo_compatibility killough 7/19/98 killough 7/19/98 killough 10/98 killough 9/8/98 killough 9/9/98 killough 10/98 killough 9/9/98 killough 3/6/98: rearrange to fix savegame bugs (moved fastparm, respawnparm, nomonsters flags to G_LoadOptions()/G_SaveOptions()) For demos from versions >= 1.4 new versions of demos skip signature; BOOM  LxDoom or MBF - determine from signature
          * cph - load compatibility level  LxDoom  cph - DEMOSYNC - LxDoom demos recorded in compatibility modes support dropped  killough 3/1/98: Read game options killough 6/3/98: partially fix v2.00 demos   printf( "G_DoPlayDemo: playing demo with %s compatibility\n",           comp_lev_str[compatibility_level]); only 4 players can exist in old demos intentionally hard-coded 4 -- killough killough 12/98: support -loadgame  killough 4/24/98 killough cph - store lump number for unlocking later  G_TimeDemo CPhipps - const char* G_CheckDemoStatus
 *
 * Called after a death or level completion to allow demos to be cleaned up
 * Returns true if a new demo loop action will take place
  killough      int endtime = I_GetTime_RealTime (); killough -- added fps information and made it work for longer demos:         exit(0);  // killough cph - unlock the demo lump killough 3/1/98 killough 3/29/98 killough 1/22/98: this is a "Doom printf" for messages. I've gotten tired of using players->message=... and so I've added this dprintf. killough 3/6/98: Made limit static to allow z_zone functions to call this function, without calling realloc(), which seems to cause problems. CPhipps - renamed to doom_printf to avoid name collision with glibc print message in buffer  set new message