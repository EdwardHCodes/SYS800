 Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:
 *     Dehacked file support
 *     New for the TeamTNT "Boom" engine
 *
 * Author: Ty Halderman, TeamTNT
 *
 *-------------------------------------------------------------------- killough 5/2/98: fixed headers, removed rendunant external declarations: sscanf  killough 10/98: new functions, to allow processing DEH files in-memory (e.g. from wads) Pointer to string Bytes remaining in string Current file descriptor  killough 10/98: emulate IO whether input really comes from a file or not If this is a real file, return regular line read If no more characters Return buffer pointer variables used in other routines in wi_stuff to allow pars in modified games #include "d_deh.h" -- we don't do that here but we declare the variables.  This externalizes everything that there is a string set for in the language files.  See d_deh.h for detailed comments, original English values etc.  These are set to the macro values, which are set by D_ENGLSH.H or D_FRENCH.H(etc).  BEX files are a better way of changing these strings globally by language. ==================================================================== Any of these can be changed using the bex extensions to get the initial values cph - const's
 *     - removed redundant "can't XXX in a netgame" strings.
  PRESSKEY; PRESSKEY; // remove duplicate y/n PRESSYN; PRESSYN; PRESSKEY; PRESSYN; PRESSYN; PRESSKEY; PRESSKEY; PRESSYN; // killough 4/4/98: endchar sc_HUSTR_KEYGREEN   = HUSTR_KEYGREEN;char sc_HUSTR_KEYINDIGO  = HUSTR_KEYINDIGO;char sc_HUSTR_KEYBROWN   = HUSTR_KEYBROWN;char sc_HUSTR_KEYRED     = HUSTR_KEYRED; CPhipps - automap rotate & overlay Ty 03/30/98 - new substitutions for background textures               during int screens end of DOOM Episode 1 end of DOOM Episode 2 end of DOOM Episode 3 end of DOOM Episode 4 DOOM2 after MAP06 DOOM2 after MAP11 DOOM2 after MAP20 DOOM2 after MAP30 DOOM2 going MAP15 to MAP31 DOOM2 going MAP31 to MAP32 Panel behind cast call blank lines are default and are not printed Ty 05/03/98 - externalized
 * cph - updated for prboom  end d_deh.h variable declarations ==================================================================== Do this for a lookup--the pointer (loaded above) is cross-referenced to a string key that is the same as the define above.  We will use strdups to set these new values that we read from the file, orphaning the original value set above. CPhipps - make strings pointed to const doubly indirect pointer to string pointer to lookup string name CPhipps - const, static
 *         - removed redundant "Can't XXX in a netgame" strings
  cph - disabled to prevent format string attacks in WAD files
                                           {&s_QSPROMPT,"QSPROMPT"},
                                           {&s_QLPROMPT,"QLPROMPT"},{c_HUSTR_KEYGREEN,"HUSTR_KEYGREEN"},{c_HUSTR_KEYINDIGO,"HUSTR_KEYINDIGO"},{c_HUSTR_KEYBROWN,"HUSTR_KEYBROWN"},{c_HUSTR_KEYRED,"HUSTR_KEYRED"}, Ty 04/08/98 - added 5 general purpose startup announcement strings for hacker use.  See m_menu.c Ty 05/03/98 CPhipps - const DOOM shareware/registered/retail (Ultimate) names. CPhipps - const**const spares?  Unused. CPhipps - const**const DOOM 2 map names. CPhipps - const**const Plutonia WAD map names. CPhipps - const**const TNT WAD map names. Function prototypes strip trailing whitespace point past leading whitespace Prototypes for block processing functions Pointers to these functions are used as the blocks are encountered. Structure deh_block is used to hold the block names that can be encountered, and the routines to use to decipher them a mnemonic block code name // CPhipps - const* handler input buffer area size, hardcodedfor now killough 8/9/98: make DEH_BLOCKMAX self-adjusting size of array as much of any key as we'll look at number of ints in the mobjinfo_t structure (!) Put all the block header values, and the function to be called when that one is encountered, in this array: CPhipps - static const 0  1  2  3  Ty 03/16/98 corrected from "Sounds" 4  5  6  7  8  9  --  end of standard "deh" entries,     begin BOOM Extensions (BEX) 10  new string changes 11  alternative block marker 12  bex codepointers by mnemonic 13  dummy to handle anything else flag to skip included deh-style text, used with INCLUDE NOTEXT directive MOBJINFO - Dehacked block name = "Thing" Usage: Thing nn (name) These are for mobjinfo_t types.  Each is an integer within the structure, so we can use index of the string in this array to offset by sizeof(int) into the mobjinfo_t array at [nn] * things are base zero but dehacked considers them to start at #1. *** CPhipps - static const .doomednum .spawnstate .spawnhealth .seestate .seesound .reactiontime .attacksound .painstate .painchance .painsound .meleestate .missilestate .deathstate .xdeathstate .deathsound .speed .radius .height .mass .damage .activesound .flags .flags .raisestate Strings that are used to indicate flags ("Bits" in mobjinfo) This is an array of bit masks that are related to p_mobj.h values, using the smae names without the MF_ in front. Ty 08/27/98 new code killough 10/98: Convert array to struct to allow multiple values, make array size variable CPhipps - const* CPhipps - static const call  P_Specialthing when touched block movement can be hit invisible but touchable inert but displayable deaf monster will try to attack right back take at least 1 step before attacking initially hang from ceiling don't apply gravity during play can jump from high places will pick up items goes through walls keep info about sliding along walls allow movement to any height don't cross lines or look at heights don't hit same species, explode on block dropped, not spawned (like ammo clip) use fuzzy draw like spectres puffs instead of blood when shot so it will slide down steps when dead float but not to target height count toward the kills total count toward the items total special handling for flying skulls do not spawn in deathmatch killough 10/98: TRANSLATION consists of 2 bits, not 1: for Boom bug-compatibility use translation table for color (players) use translation table for color (players) unused bit # 1 -- For Boom bug-compatibility unused bit # 2 -- For Boom compatibility for stealth monsters unused bit # 3 -- For Boom compatibility unused bit # 4 -- For Boom compatibility Translucency 25% Translucency 50% Translucency 25% + Translucency 50% = 75% apply translucency to sprite (BOOM) dies on contact with solid objects (MBF) bounces off floors, ceilings and maybe walls a friend of the player(s) (MBF) STATE - Dehacked block name = "Frame" and "Pointer" Usage: Frame nn Usage: Pointer nn (Frame nn) These are indexed separately, for lookup to the actual function pointers.  Here we'll take whatever Dehacked gives us and go from there.  The (Frame nn) after the pointer is the real place to put this value.  The "Pointer" value is an xref that Dehacked uses and is useless to us. * states are base zero and have a dummy #0 (TROO) CPhipps - static const* .sprite (spritenum_t) // an enum .frame (long) .tics (long) .nextstate (statenum_t) This is set in a separate "Pointer" block from Dehacked pointer to first use of action (actionf_t) .misc1 (long) .misc2 (long) SFXINFO_STRUCT - Dehacked block name = "Sounds" Sound effects, typically not changed (redirected, and new sfx put into the pwad, but not changed here.  Can you tell that Gregdidn't know what they were for, mostly?  Can you tell that I don't either? Mostly I just put these into the same slots as they are in the struct. This may not be supported in our -deh option if it doesn't make sense by then. * sounds are base zero but have a dummy #0 CPhipps - static const* pointer to a name string, changed in text .singularity (int, one at a time flag) .priority .link (sfxinfo_t*) referenced sound if linked .pitch .volume .data (SAMPLE*) sound data .usefulness .lumpnum MUSICINFO is not supported in Dehacked.  Ignored here. * music entries are base zero but have a dummy #0 CPhipps - unused? SPRITE - Dehacked block name = "Sprite" Usage = Sprite nn Sprite redirection by offset into the text area - unsupported by BOOM * sprites are base zero and dehacked uses it that way. CPhipps - static const* supposed to be the offset into the text section AMMO - Dehacked block name = "Ammo" usage = Ammo n (name) Ammo information for the few types of ammo CPhipps - static const* maxammo[] clipammo[] WEAPONS - Dehacked block name = "Weapon" Usage: Weapon nn (name) Basically a list of frames and what kind of ammo (see above)it uses. CPhipps - static const* .ammo .upstate .downstate .readystate .atkstate .flashstate CHEATS - Dehacked block name = "Cheat" Usage: Cheat 0 Always uses a zero in the dehacked file, for consistency.  No meaning. These are just plain funky terms compared with id's killough 4/18/98: integrated into main cheat table now (see st_stuff.c) MISC - Dehacked block name = "Misc" Usage: Misc 0 Always uses a zero in the dehacked file, for consistency.  No meaning. CPhipps - static const* initial_health initial_bullets maxhealth max_armor green_armor_class blue_armor_class max_soul soul_health mega_health god_health idfa_armor idfa_armor_class idkfa_armor idkfa_armor_class BFGCELLS Unknown--not a specific number it seems, but the logic has to be here somewhere or it'd happen always TEXT - Dehacked block name = "Text" Usage: Text fromlen tolen Dehacked allows a bit of adjustment to the length (why?) BEX extension [CODEPTR] Usage: Start block, then each line is: FRAME nnn = PointerMnemonic External references to action functions scattered about the code killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 actual pointer to the subroutine mnemonic lookup string to be specified in BEX CPhipps - const* CPhipps - static const killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 This NULL entry must be the last in the list Ty 05/16/98 to hold startup code pointers from INFO.C CPhipps - static ==================================================================== ProcessDehFile Purpose: Read and process a DEH or BEX file Args:    filename    -- name of the DEH/BEX file          outfilename -- output file (DEHOUT.TXT), appended to here Returns: void killough 10/98: substantially modified to allow input from wad lumps instead of .deh files. In case -dehout was used killough 10/98 Place to put the primary infostring Open output file if we're writing output to allow append to output log killough 10/98: allow DEH files to come from wad lumps should be checked up front anyway DEH file comes from lump indicated by third argument killough 10/98: only run once, by keeping index static remember what they start as for deh xref loop until end of file Blank line or comment line  -- If DEH_BLOCKMAX is set right, the processing is independently -- handled based on data in the deh_blocks[] structure array killough 10/98: INCLUDE code rewritten to allow arbitrary nesting, and to greatly simplify code, fix memory leaks, other bugs include a file preserve state while including a file killough 10/98: moved to here killough 10/98 killough 10/98: exclude if inside wads (only to discourage the practice, since the code could otherwise handle it) check for no-text directive, used when including a DEH file but using the BEX format to handle strings killough 10/98: Second argument must be NULL to prevent closing fileout too soon do the included file matches one call function we got one, that's enough for this block Mark purgable Close real file ==================================================================== deh_procBexCodePointers Purpose: Handle [CODEPTR] block, BOOM Extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void to hold the codepointer mnemonic looper know if we found this one during lookup or not Ty 05/16/98 - initialize it to something, dummy! for this one, we just read 'em until we hit a blank line killough 11/98: really exit on blank line killough 8/98: allow hex numbers in input: NOTE: different format from normal early return killough 10/98: fix SegViol reusing the key area to prefix the mnemonic incremented to start at zero at the top of the loop Ty 05/16/98 - fix loop logic to look for null ending entry Ty 06/01/98  - add  to states[].action for new djgcc version assign--------------------------------------------------------------------------- To be on the safe, compatible side, we manually convert DEH bitflags to prboom types - POPE--------------------------------------------------------------------------- cf linuxdoom-1.10 p_mobj.h  0 Can be picked up. When touched the thing can be picked up. 1 Obstacle. The thing is solid and will not let you (or others) pass through it 2 Shootable. Can be shot. 3 Total Invisibility. Invisible, but can be touched 4 Don't use the blocklinks (inert but displayable) 5 Semi deaf. The thing is a deaf monster 6 In pain. Will try to attack right back after being hit 7 Steps before attack. Will take at least one step before attacking 8 Hangs from ceiling. When the level starts, this thing will be at ceiling height. 9 No gravity – Gravity does not affect this thing 10 Travels over cliffs – Monsters normally do not walk off ledges/steps they could not walk up. With this set they can walk off any height of cliff. Usually only used for flying monsters. 11 Pick up items – The thing can pick up gettable items. 12 No clipping - Thing can walk through walls. 13 Slides along walls – Keep info about sliding along walls (don’t really know much about this one). 14 Floating – Thing can move to any height 15 Semi no clipping – Don’t cross lines or look at teleport heights. (don’t really know much about this one either). 16 Projectiles – Behaves like a projectile, explodes when hitting something that blocks movement 17 Disappearing weapon – Dropped, not spawned (like an ammo clip) I have not had much success in using this one. 18 Partial invisibility – Drawn like a spectre. 19 Puffs (vs. bleeds) – If hit will spawn bullet puffs instead of blood splats. 20 Sliding helpless – Will slide down steps when dead. 21 No auto levelling - float but not to target height (?) 22 Affects kill % – counted as a killable enemy and affects percentage kills on level summary. 23 Affects item % –affects percentage items gathered on level summary. 24 Running - special handling for flying skulls. 25 Not in deathmatch - do not spawn in deathmatch (like keys) 26 Color 1 (grey / red) 27 Color 2 (brown / red) 28 and 29 allow the green colours in a thing’s graphics to be remapped to a different colour like the players uniforms in multiplayer games. Leaving all the bits alone, the thing stays green. Setting 26 it becomes grey. Setting 27 it becomes brown. Setting both 26 and 27 it becomes red.--------------------------------------------------------------------------- See usage below for an explanation of this function's existence - POPE--------------------------------------------------------------------------- ==================================================================== deh_procThing Purpose: Handle DEH Thing block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Ty 8/27/98 - revised to also allow mnemonics for bit masks for monster attributes All deh values are ints or longs killough 8/98: allow hex numbers in input: Note that the mobjinfo[] array is base zero, but object numbers in the dehacked file start with one.  Grumble. now process the stuff Note that for Things we can look up the key and use its offset in the array of key strings as an int offset in the structure get a line until a blank or end of file--it's not blank now because it has our incoming key in it killough 11/98: really bail out on blank lines (break != continue) bail out with blank line between sections returns TRUE if ok standard value set The old code here was the cause of a DEH-related bug in prboom. When the mobjinfo_t.flags member was graduated to an int64, this code was caught unawares and was indexing each property of the mobjinfo as if it were still an int32. This caused sets of the "raisestate" member to partially overwrite the "flags" member, thus screwing everything up and making most DEH patches result in unshootable enemy types. Moved to a separate function above and stripped of all hairy struct address indexing. - POPE bit set proff figure out what the bits are killough 10/98: replace '+' kludge with strtok() loop Fix error-handling case ('found' var wasn't being reset) Use OR logic instead of addition, to allow repetition Don't worry about conversion -- simply print values ==================================================================== deh_procFrame Purpose: Handle DEH Frame block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Sprite number Sprite subnumber long Duration long Next frame Codep frame (not set in Frame deh block) nop  Unknown 1 long Unknown 2 long ==================================================================== deh_procPointer Purpose: Handle DEH Code pointer block, can use BEX [CODEPTR] instead Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs looper NOTE: different format from normal killough 8/98: allow hex numbers in input, fix error case: killough 11/98 returns TRUE if ok Codep frame (not set in Frame deh block) Write BEX-oriented line to match: ==================================================================== deh_procSounds Purpose: Handle DEH Sounds block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Offset nop  we don't know what this is, I don't think Zero/One Value Zero 1 Zero 2 Zero 3 Zero 4 killough 5/3/98: changed cast Neg. One 1 Neg. One 2 ==================================================================== deh_procAmmo Purpose: Handle DEH Ammo block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Max ammo Per ammo ==================================================================== deh_procWeapon Purpose: Handle DEH Weapon block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Ammo type Deselect frame Select frame Bobbing frame Shooting frame Firing frame ==================================================================== deh_procSprite Purpose: Dummy - we do not support the DEH Sprite block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Not supported Too little is known about what this is supposed to do, and there are better ways of handling sprite renaming.  Not supported. killough 8/98: allow hex numbers in input: killough 11/98 ignore line ==================================================================== deh_procPars Purpose: Handle BEX extension for PAR times Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void extension new item, par times usage: After [PARS] Par 0 section identifier, use one or more of these lines:  par 3 5 120  par 14 230 The first would make the par for E3M5 be 120 seconds, and the second one makes the par for MAP14 be 230 seconds.  The number of parameters on the line determines which group of par values is being changed.  Error checking is done based on current fixed array sizes of[4][10] and [32] killough 8/98: allow hex numbers in input: indexnum is a dummy entry lowercase it killough 11/98 not 3 not 2 is 2 Ty 07/11/98 - wrong range check, not zero-based base 0 array (but 1-based parm) is 3 note that though it's a [4][10] array, the "left" and "top" aren't used, effectively making it a base 1 array. Ty 07/11/98 - level was being checked against max 3 - dumb error Note that episode 4 does not have par times per original design in Ultimate DOOM so that is not supported here. ==================================================================== deh_procCheat Purpose: Handle DEH Cheat block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done   char key[DEH_MAXKEYLEN];
   char inbuffer[DEH_BUFFERMAX];
   uint_64_t value;      // All deh values are ints or longs
   char ch = 0; // CPhipps - `writable' null string to initialise...
   char *strval = &ch;  // pointer to the value area
   int ix, iy;   // array indices
   char *p;  // utility pointer

   if (fpout) fdprintf(fpout,"Processing Cheat: %s\n",line);

   strncpy(inbuffer,line,DEH_BUFFERMAX);
   while (!dehfeof(fpin) && *inbuffer && (*inbuffer != ' '))
   {
      if (!dehfgets(inbuffer, sizeof(inbuffer), fpin)) break;
      if (!*inbuffer) break;       // killough 11/98
      if (!deh_GetData(inbuffer,key,&value,&strval,fpout)) // returns TRUE if ok
      {
         if (fpout) fdprintf(fpout,"Bad data pair in '%s'\n",inbuffer);
         continue;
      }
      // Otherwise we got a (perhaps valid) cheat name,
      // so look up the key in the array

      // killough 4/18/98: use main cheat code table in st_stuff.c now
      for (ix=0; cheat[ix].cheat; ix++)
         if (cheat[ix].deh_cheat)   // killough 4/18/98: skip non-deh
         {
            if (!stricmp(key,cheat[ix].deh_cheat))  // found the cheat, ignored case
            {
               // replace it but don't overflow it.  Use current length as limit.
               // Ty 03/13/98 - add 0xff code
               // Deal with the fact that the cheats in deh files are extended
               // with character 0xFF to the original cheat length, which we don't do.
               for (iy=0; strval[iy]; iy++)
                  strval[iy] = (strval[iy]==(char)0xff) ? '\0' : strval[iy];

               iy = ix;     // killough 4/18/98

               // Ty 03/14/98 - skip leading spaces
               p = strval;
               while (*p == ' ') ++p;
               // Ty 03/16/98 - change to use a strdup and orphan the original
               // Also has the advantage of allowing length changes.
               // strncpy(cheat[iy].cheat,p,strlen(cheat[iy].cheat));
#if 0
               {    // killough 9/12/98: disable cheats which are prefixes of this one
                  int i;
                  for (i=0; cheat[i].cheat; i++)
                     if (cheat[i].when & not_deh &&
                           !strncasecmp(cheat[i].cheat,
                                        cheat[iy].cheat,
                                        strlen(cheat[i].cheat)) && i != iy)
                        cheat[i].deh_modified = true;
               }
#endif
               cheat[iy].cheat = strdup(p);
               if (fpout) fdprintf(fpout,
                                     "Assigned new cheat '%s' to cheat '%s'at index %d\n",
                                     p, cheat[ix].deh_cheat, iy); // killough 4/18/98
            }
         }
      if (fpout) fdprintf(fpout,"- %s\n",inbuffer);
   }
   return;
 ==================================================================== deh_procMisc Purpose: Handle DEH Misc block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs killough 11/98 returns TRUE if ok Otherwise it's ok Initial Health Initial Bullets Max Health Max Armor Green Armor Class Blue Armor Class Max Soulsphere Soulsphere Health Megasphere Health God Mode Health IDFA Armor IDFA Armor Class IDKFA Armor IDKFA Armor Class BFG Cells/Shot Monsters Infight No such switch in DOOM - nop  ==================================================================== deh_procText Purpose: Handle DEH Text block Notes:   We look things up in the current information and if found          we replace it.  At the same time we write the new and          improved BEX syntax to the log file for future use. Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void can't use line -- double size buffer too. loop variable as specified on the text block line shorter of fromlen and tolen if not matched to allow early exit once found duplicate line for rerouting Ty 04/11/98 - Included file may have NOTEXT skip flag set flag to skip included deh-style text skip block Ty 05/17/98 - don't care if this fails ************** Early return killough 8/98: allow hex numbers in input: killough 10/98: fix incorrect usage of feof if the from and to are 4, this may be a sprite rename.  Check it against the array and process it as such if it matches.  Remember that the original names are (and should remain) uppercase. Future: this will be from a separate [SPRITES] block. null terminated list in info.c //jff 3/19/98check pointernot first char Ty 03/18/98 - not using strdup because length is fixed killough 10/98: but it's an array of pointers, so we must use strdup unless we redeclare sprnames and change all else CPhipps - fix constness problem only one will match--quit early next array element lengths of music and sfx are 6 or shorter Try sound effects entries - see sounds.c avoid short prefix erroneous match only one matches, quit early not yet Try music name entries - see sounds.c avoid short prefix erroneous match only one matches, quit early end !found test Nothing we want to handle here--see if strings can deal with it. may be NULL, ignored by free() ==================================================================== deh_procStrings Purpose: Handle BEX [STRINGS] extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs holds the string value of the line maximum string length, bumped 128 at a time as needed holds the final result of the string after concatenation looking for string continuation empty string to start with Ty 04/24/98 - have to allow inbuffer to start with a blank for the continuations of C1TEXT etc. && (*inbuffer != ' ')  skip comment lines killough 11/98 first one--get the key returns TRUE if ok Ty03/29/98 - fix stupid error killough 11/98: allocate enough the first time concatenate the whole buffer if continuation or the value iffirst delete any trailing blanks past the backslash note that blanks before the backslash will be concatenated but ones at the beginning of the next line will not, allowing indentation in the file to read well without affecting the string itself. ready to concatenate didn't have a backslash, trap above would catch that go process the current string supply keyand not search string empty string for the next one ==================================================================== deh_procStringSub Purpose: Common string parsing and handling routine for DEH and BEX Args:    key       -- place to put the mnemonic for the string if found          lookfor   -- original value string to look for          newstring -- string to put in its place if found          fpout     -- file stream pointer for log file (DEHOUT.TXT) Returns: boolean: True if string found, false if not loop exit flag looper orphan originalstring Handle embedded \n's in the incoming string, convert to 0x0a'sfound one skip one extra for second character cap off the target string must have passed an old style string so showBEX ==================================================================== General utility function(s) ==================================================================== ==================================================================== dehReformatStr Purpose: Convert a string into a continuous string with embedded          linefeeds for "\n" sequences in the source string Args:    string -- the string to convert Returns: the converted string (converted in a static buffer) only processing the changed string,  don't need double buffer source target let's play... ==================================================================== rstrip Purpose: Strips trailing blanks off a string Args:    s -- the string to work on Returns: void -- the string is modified in place strip trailing whitespace killough 4/4/98: same here break on first non-whitespace ==================================================================== ptr_lstrip Purpose: Points past leading whitespace in a string Args:    s -- the string to work on Returns: char * pointing to the first nonblank character in the          string.  The original string is not changed. point past leading whitespace ==================================================================== deh_GetData Purpose: Get a key and data pair from a passed string Args:    s -- the string to be examined          k -- a place to put the key          l -- pointer to a long integer to store the number          strval -- a pointer to the place in s where the number                    value comes from.  Pass NULL to not use this.          fpout  -- stream pointer to output log (DEHOUT.TXT) Notes:   Expects a key phrase, optional space, equal sign,          optional space and a value, mostly an int but treated          as a long just in case.  The passed pointer to hold          the key must be DEH_MAXKEYLEN in size. current char to hold value of pair to hold key in progress assume good unless we have problems iterator defaults in case not otherwise set copy it terminate the key before the '=' end of string with no equal sign in case "thiskey =" with no value we've incremented tstrtol(t,NULL,0);  // killough 8/9/98: allow hex or octal input go put the results in the passed pointers may be a faked zero if spaces between key and equal sign, strip them could be a zero-length string pass NULL if you don't want this back pointer, has to be somewhere in s, even if pointing at the zero byte. Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:
 *     Dehacked file support
 *     New for the TeamTNT "Boom" engine
 *
 * Author: Ty Halderman, TeamTNT
 *
 *-------------------------------------------------------------------- killough 5/2/98: fixed headers, removed rendunant external declarations: sscanf  killough 10/98: new functions, to allow processing DEH files in-memory (e.g. from wads) Pointer to string Bytes remaining in string Current file descriptor  killough 10/98: emulate IO whether input really comes from a file or not If this is a real file, return regular line read If no more characters Return buffer pointer variables used in other routines in wi_stuff to allow pars in modified games #include "d_deh.h" -- we don't do that here but we declare the variables.  This externalizes everything that there is a string set for in the language files.  See d_deh.h for detailed comments, original English values etc.  These are set to the macro values, which are set by D_ENGLSH.H or D_FRENCH.H(etc).  BEX files are a better way of changing these strings globally by language. ==================================================================== Any of these can be changed using the bex extensions to get the initial values cph - const's
 *     - removed redundant "can't XXX in a netgame" strings.
  PRESSKEY; PRESSKEY; // remove duplicate y/n PRESSYN; PRESSYN; PRESSKEY; PRESSYN; PRESSYN; PRESSKEY; PRESSKEY; PRESSYN; // killough 4/4/98: endchar sc_HUSTR_KEYGREEN   = HUSTR_KEYGREEN;char sc_HUSTR_KEYINDIGO  = HUSTR_KEYINDIGO;char sc_HUSTR_KEYBROWN   = HUSTR_KEYBROWN;char sc_HUSTR_KEYRED     = HUSTR_KEYRED; CPhipps - automap rotate & overlay Ty 03/30/98 - new substitutions for background textures               during int screens end of DOOM Episode 1 end of DOOM Episode 2 end of DOOM Episode 3 end of DOOM Episode 4 DOOM2 after MAP06 DOOM2 after MAP11 DOOM2 after MAP20 DOOM2 after MAP30 DOOM2 going MAP15 to MAP31 DOOM2 going MAP31 to MAP32 Panel behind cast call blank lines are default and are not printed Ty 05/03/98 - externalized
 * cph - updated for prboom  end d_deh.h variable declarations ==================================================================== Do this for a lookup--the pointer (loaded above) is cross-referenced to a string key that is the same as the define above.  We will use strdups to set these new values that we read from the file, orphaning the original value set above. CPhipps - make strings pointed to const doubly indirect pointer to string pointer to lookup string name CPhipps - const, static
 *         - removed redundant "Can't XXX in a netgame" strings
  cph - disabled to prevent format string attacks in WAD files
                                           {&s_QSPROMPT,"QSPROMPT"},
                                           {&s_QLPROMPT,"QLPROMPT"},{c_HUSTR_KEYGREEN,"HUSTR_KEYGREEN"},{c_HUSTR_KEYINDIGO,"HUSTR_KEYINDIGO"},{c_HUSTR_KEYBROWN,"HUSTR_KEYBROWN"},{c_HUSTR_KEYRED,"HUSTR_KEYRED"}, Ty 04/08/98 - added 5 general purpose startup announcement strings for hacker use.  See m_menu.c Ty 05/03/98 CPhipps - const DOOM shareware/registered/retail (Ultimate) names. CPhipps - const**const spares?  Unused. CPhipps - const**const DOOM 2 map names. CPhipps - const**const Plutonia WAD map names. CPhipps - const**const TNT WAD map names. Function prototypes strip trailing whitespace point past leading whitespace Prototypes for block processing functions Pointers to these functions are used as the blocks are encountered. Structure deh_block is used to hold the block names that can be encountered, and the routines to use to decipher them a mnemonic block code name // CPhipps - const* handler input buffer area size, hardcodedfor now killough 8/9/98: make DEH_BLOCKMAX self-adjusting size of array as much of any key as we'll look at number of ints in the mobjinfo_t structure (!) Put all the block header values, and the function to be called when that one is encountered, in this array: CPhipps - static const 0  1  2  3  Ty 03/16/98 corrected from "Sounds" 4  5  6  7  8  9  --  end of standard "deh" entries,     begin BOOM Extensions (BEX) 10  new string changes 11  alternative block marker 12  bex codepointers by mnemonic 13  dummy to handle anything else flag to skip included deh-style text, used with INCLUDE NOTEXT directive MOBJINFO - Dehacked block name = "Thing" Usage: Thing nn (name) These are for mobjinfo_t types.  Each is an integer within the structure, so we can use index of the string in this array to offset by sizeof(int) into the mobjinfo_t array at [nn] * things are base zero but dehacked considers them to start at #1. *** CPhipps - static const .doomednum .spawnstate .spawnhealth .seestate .seesound .reactiontime .attacksound .painstate .painchance .painsound .meleestate .missilestate .deathstate .xdeathstate .deathsound .speed .radius .height .mass .damage .activesound .flags .flags .raisestate Strings that are used to indicate flags ("Bits" in mobjinfo) This is an array of bit masks that are related to p_mobj.h values, using the smae names without the MF_ in front. Ty 08/27/98 new code killough 10/98: Convert array to struct to allow multiple values, make array size variable CPhipps - const* CPhipps - static const call  P_Specialthing when touched block movement can be hit invisible but touchable inert but displayable deaf monster will try to attack right back take at least 1 step before attacking initially hang from ceiling don't apply gravity during play can jump from high places will pick up items goes through walls keep info about sliding along walls allow movement to any height don't cross lines or look at heights don't hit same species, explode on block dropped, not spawned (like ammo clip) use fuzzy draw like spectres puffs instead of blood when shot so it will slide down steps when dead float but not to target height count toward the kills total count toward the items total special handling for flying skulls do not spawn in deathmatch killough 10/98: TRANSLATION consists of 2 bits, not 1: for Boom bug-compatibility use translation table for color (players) use translation table for color (players) unused bit # 1 -- For Boom bug-compatibility unused bit # 2 -- For Boom compatibility for stealth monsters unused bit # 3 -- For Boom compatibility unused bit # 4 -- For Boom compatibility Translucency 25% Translucency 50% Translucency 25% + Translucency 50% = 75% apply translucency to sprite (BOOM) dies on contact with solid objects (MBF) bounces off floors, ceilings and maybe walls a friend of the player(s) (MBF) STATE - Dehacked block name = "Frame" and "Pointer" Usage: Frame nn Usage: Pointer nn (Frame nn) These are indexed separately, for lookup to the actual function pointers.  Here we'll take whatever Dehacked gives us and go from there.  The (Frame nn) after the pointer is the real place to put this value.  The "Pointer" value is an xref that Dehacked uses and is useless to us. * states are base zero and have a dummy #0 (TROO) CPhipps - static const* .sprite (spritenum_t) // an enum .frame (long) .tics (long) .nextstate (statenum_t) This is set in a separate "Pointer" block from Dehacked pointer to first use of action (actionf_t) .misc1 (long) .misc2 (long) SFXINFO_STRUCT - Dehacked block name = "Sounds" Sound effects, typically not changed (redirected, and new sfx put into the pwad, but not changed here.  Can you tell that Gregdidn't know what they were for, mostly?  Can you tell that I don't either? Mostly I just put these into the same slots as they are in the struct. This may not be supported in our -deh option if it doesn't make sense by then. * sounds are base zero but have a dummy #0 CPhipps - static const* pointer to a name string, changed in text .singularity (int, one at a time flag) .priority .link (sfxinfo_t*) referenced sound if linked .pitch .volume .data (SAMPLE*) sound data .usefulness .lumpnum MUSICINFO is not supported in Dehacked.  Ignored here. * music entries are base zero but have a dummy #0 CPhipps - unused? SPRITE - Dehacked block name = "Sprite" Usage = Sprite nn Sprite redirection by offset into the text area - unsupported by BOOM * sprites are base zero and dehacked uses it that way. CPhipps - static const* supposed to be the offset into the text section AMMO - Dehacked block name = "Ammo" usage = Ammo n (name) Ammo information for the few types of ammo CPhipps - static const* maxammo[] clipammo[] WEAPONS - Dehacked block name = "Weapon" Usage: Weapon nn (name) Basically a list of frames and what kind of ammo (see above)it uses. CPhipps - static const* .ammo .upstate .downstate .readystate .atkstate .flashstate CHEATS - Dehacked block name = "Cheat" Usage: Cheat 0 Always uses a zero in the dehacked file, for consistency.  No meaning. These are just plain funky terms compared with id's killough 4/18/98: integrated into main cheat table now (see st_stuff.c) MISC - Dehacked block name = "Misc" Usage: Misc 0 Always uses a zero in the dehacked file, for consistency.  No meaning. CPhipps - static const* initial_health initial_bullets maxhealth max_armor green_armor_class blue_armor_class max_soul soul_health mega_health god_health idfa_armor idfa_armor_class idkfa_armor idkfa_armor_class BFGCELLS Unknown--not a specific number it seems, but the logic has to be here somewhere or it'd happen always TEXT - Dehacked block name = "Text" Usage: Text fromlen tolen Dehacked allows a bit of adjustment to the length (why?) BEX extension [CODEPTR] Usage: Start block, then each line is: FRAME nnn = PointerMnemonic External references to action functions scattered about the code killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 actual pointer to the subroutine mnemonic lookup string to be specified in BEX CPhipps - const* CPhipps - static const killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 This NULL entry must be the last in the list Ty 05/16/98 to hold startup code pointers from INFO.C CPhipps - static ==================================================================== ProcessDehFile Purpose: Read and process a DEH or BEX file Args:    filename    -- name of the DEH/BEX file          outfilename -- output file (DEHOUT.TXT), appended to here Returns: void killough 10/98: substantially modified to allow input from wad lumps instead of .deh files. In case -dehout was used killough 10/98 Place to put the primary infostring Open output file if we're writing output to allow append to output log killough 10/98: allow DEH files to come from wad lumps should be checked up front anyway DEH file comes from lump indicated by third argument killough 10/98: only run once, by keeping index static remember what they start as for deh xref loop until end of file Blank line or comment line  -- If DEH_BLOCKMAX is set right, the processing is independently -- handled based on data in the deh_blocks[] structure array killough 10/98: INCLUDE code rewritten to allow arbitrary nesting, and to greatly simplify code, fix memory leaks, other bugs include a file preserve state while including a file killough 10/98: moved to here killough 10/98 killough 10/98: exclude if inside wads (only to discourage the practice, since the code could otherwise handle it) check for no-text directive, used when including a DEH file but using the BEX format to handle strings killough 10/98: Second argument must be NULL to prevent closing fileout too soon do the included file matches one call function we got one, that's enough for this block Mark purgable Close real file ==================================================================== deh_procBexCodePointers Purpose: Handle [CODEPTR] block, BOOM Extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void to hold the codepointer mnemonic looper know if we found this one during lookup or not Ty 05/16/98 - initialize it to something, dummy! for this one, we just read 'em until we hit a blank line killough 11/98: really exit on blank line killough 8/98: allow hex numbers in input: NOTE: different format from normal early return killough 10/98: fix SegViol reusing the key area to prefix the mnemonic incremented to start at zero at the top of the loop Ty 05/16/98 - fix loop logic to look for null ending entry Ty 06/01/98  - add  to states[].action for new djgcc version assign--------------------------------------------------------------------------- To be on the safe, compatible side, we manually convert DEH bitflags to prboom types - POPE--------------------------------------------------------------------------- cf linuxdoom-1.10 p_mobj.h  0 Can be picked up. When touched the thing can be picked up. 1 Obstacle. The thing is solid and will not let you (or others) pass through it 2 Shootable. Can be shot. 3 Total Invisibility. Invisible, but can be touched 4 Don't use the blocklinks (inert but displayable) 5 Semi deaf. The thing is a deaf monster 6 In pain. Will try to attack right back after being hit 7 Steps before attack. Will take at least one step before attacking 8 Hangs from ceiling. When the level starts, this thing will be at ceiling height. 9 No gravity – Gravity does not affect this thing 10 Travels over cliffs – Monsters normally do not walk off ledges/steps they could not walk up. With this set they can walk off any height of cliff. Usually only used for flying monsters. 11 Pick up items – The thing can pick up gettable items. 12 No clipping - Thing can walk through walls. 13 Slides along walls – Keep info about sliding along walls (don’t really know much about this one). 14 Floating – Thing can move to any height 15 Semi no clipping – Don’t cross lines or look at teleport heights. (don’t really know much about this one either). 16 Projectiles – Behaves like a projectile, explodes when hitting something that blocks movement 17 Disappearing weapon – Dropped, not spawned (like an ammo clip) I have not had much success in using this one. 18 Partial invisibility – Drawn like a spectre. 19 Puffs (vs. bleeds) – If hit will spawn bullet puffs instead of blood splats. 20 Sliding helpless – Will slide down steps when dead. 21 No auto levelling - float but not to target height (?) 22 Affects kill % – counted as a killable enemy and affects percentage kills on level summary. 23 Affects item % –affects percentage items gathered on level summary. 24 Running - special handling for flying skulls. 25 Not in deathmatch - do not spawn in deathmatch (like keys) 26 Color 1 (grey / red) 27 Color 2 (brown / red) 28 and 29 allow the green colours in a thing’s graphics to be remapped to a different colour like the players uniforms in multiplayer games. Leaving all the bits alone, the thing stays green. Setting 26 it becomes grey. Setting 27 it becomes brown. Setting both 26 and 27 it becomes red.--------------------------------------------------------------------------- See usage below for an explanation of this function's existence - POPE--------------------------------------------------------------------------- ==================================================================== deh_procThing Purpose: Handle DEH Thing block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Ty 8/27/98 - revised to also allow mnemonics for bit masks for monster attributes All deh values are ints or longs killough 8/98: allow hex numbers in input: Note that the mobjinfo[] array is base zero, but object numbers in the dehacked file start with one.  Grumble. now process the stuff Note that for Things we can look up the key and use its offset in the array of key strings as an int offset in the structure get a line until a blank or end of file--it's not blank now because it has our incoming key in it killough 11/98: really bail out on blank lines (break != continue) bail out with blank line between sections returns TRUE if ok standard value set The old code here was the cause of a DEH-related bug in prboom. When the mobjinfo_t.flags member was graduated to an int64, this code was caught unawares and was indexing each property of the mobjinfo as if it were still an int32. This caused sets of the "raisestate" member to partially overwrite the "flags" member, thus screwing everything up and making most DEH patches result in unshootable enemy types. Moved to a separate function above and stripped of all hairy struct address indexing. - POPE bit set proff figure out what the bits are killough 10/98: replace '+' kludge with strtok() loop Fix error-handling case ('found' var wasn't being reset) Use OR logic instead of addition, to allow repetition Don't worry about conversion -- simply print values ==================================================================== deh_procFrame Purpose: Handle DEH Frame block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Sprite number Sprite subnumber long Duration long Next frame Codep frame (not set in Frame deh block) nop  Unknown 1 long Unknown 2 long ==================================================================== deh_procPointer Purpose: Handle DEH Code pointer block, can use BEX [CODEPTR] instead Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs looper NOTE: different format from normal killough 8/98: allow hex numbers in input, fix error case: killough 11/98 returns TRUE if ok Codep frame (not set in Frame deh block) Write BEX-oriented line to match: ==================================================================== deh_procSounds Purpose: Handle DEH Sounds block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Offset nop  we don't know what this is, I don't think Zero/One Value Zero 1 Zero 2 Zero 3 Zero 4 killough 5/3/98: changed cast Neg. One 1 Neg. One 2 ==================================================================== deh_procAmmo Purpose: Handle DEH Ammo block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Max ammo Per ammo ==================================================================== deh_procWeapon Purpose: Handle DEH Weapon block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Ammo type Deselect frame Select frame Bobbing frame Shooting frame Firing frame ==================================================================== deh_procSprite Purpose: Dummy - we do not support the DEH Sprite block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Not supported Too little is known about what this is supposed to do, and there are better ways of handling sprite renaming.  Not supported. killough 8/98: allow hex numbers in input: killough 11/98 ignore line ==================================================================== deh_procPars Purpose: Handle BEX extension for PAR times Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void extension new item, par times usage: After [PARS] Par 0 section identifier, use one or more of these lines:  par 3 5 120  par 14 230 The first would make the par for E3M5 be 120 seconds, and the second one makes the par for MAP14 be 230 seconds.  The number of parameters on the line determines which group of par values is being changed.  Error checking is done based on current fixed array sizes of[4][10] and [32] killough 8/98: allow hex numbers in input: indexnum is a dummy entry lowercase it killough 11/98 not 3 not 2 is 2 Ty 07/11/98 - wrong range check, not zero-based base 0 array (but 1-based parm) is 3 note that though it's a [4][10] array, the "left" and "top" aren't used, effectively making it a base 1 array. Ty 07/11/98 - level was being checked against max 3 - dumb error Note that episode 4 does not have par times per original design in Ultimate DOOM so that is not supported here. ==================================================================== deh_procCheat Purpose: Handle DEH Cheat block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done   char key[DEH_MAXKEYLEN];
   char inbuffer[DEH_BUFFERMAX];
   uint_64_t value;      // All deh values are ints or longs
   char ch = 0; // CPhipps - `writable' null string to initialise...
   char *strval = &ch;  // pointer to the value area
   int ix, iy;   // array indices
   char *p;  // utility pointer

   if (fpout) fdprintf(fpout,"Processing Cheat: %s\n",line);

   strncpy(inbuffer,line,DEH_BUFFERMAX);
   while (!dehfeof(fpin) && *inbuffer && (*inbuffer != ' '))
   {
      if (!dehfgets(inbuffer, sizeof(inbuffer), fpin)) break;
      if (!*inbuffer) break;       // killough 11/98
      if (!deh_GetData(inbuffer,key,&value,&strval,fpout)) // returns TRUE if ok
      {
         if (fpout) fdprintf(fpout,"Bad data pair in '%s'\n",inbuffer);
         continue;
      }
      // Otherwise we got a (perhaps valid) cheat name,
      // so look up the key in the array

      // killough 4/18/98: use main cheat code table in st_stuff.c now
      for (ix=0; cheat[ix].cheat; ix++)
         if (cheat[ix].deh_cheat)   // killough 4/18/98: skip non-deh
         {
            if (!stricmp(key,cheat[ix].deh_cheat))  // found the cheat, ignored case
            {
               // replace it but don't overflow it.  Use current length as limit.
               // Ty 03/13/98 - add 0xff code
               // Deal with the fact that the cheats in deh files are extended
               // with character 0xFF to the original cheat length, which we don't do.
               for (iy=0; strval[iy]; iy++)
                  strval[iy] = (strval[iy]==(char)0xff) ? '\0' : strval[iy];

               iy = ix;     // killough 4/18/98

               // Ty 03/14/98 - skip leading spaces
               p = strval;
               while (*p == ' ') ++p;
               // Ty 03/16/98 - change to use a strdup and orphan the original
               // Also has the advantage of allowing length changes.
               // strncpy(cheat[iy].cheat,p,strlen(cheat[iy].cheat));
#if 0
               {    // killough 9/12/98: disable cheats which are prefixes of this one
                  int i;
                  for (i=0; cheat[i].cheat; i++)
                     if (cheat[i].when & not_deh &&
                           !strncasecmp(cheat[i].cheat,
                                        cheat[iy].cheat,
                                        strlen(cheat[i].cheat)) && i != iy)
                        cheat[i].deh_modified = true;
               }
#endif
               cheat[iy].cheat = strdup(p);
               if (fpout) fdprintf(fpout,
                                     "Assigned new cheat '%s' to cheat '%s'at index %d\n",
                                     p, cheat[ix].deh_cheat, iy); // killough 4/18/98
            }
         }
      if (fpout) fdprintf(fpout,"- %s\n",inbuffer);
   }
   return;
 ==================================================================== deh_procMisc Purpose: Handle DEH Misc block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs killough 11/98 returns TRUE if ok Otherwise it's ok Initial Health Initial Bullets Max Health Max Armor Green Armor Class Blue Armor Class Max Soulsphere Soulsphere Health Megasphere Health God Mode Health IDFA Armor IDFA Armor Class IDKFA Armor IDKFA Armor Class BFG Cells/Shot Monsters Infight No such switch in DOOM - nop  ==================================================================== deh_procText Purpose: Handle DEH Text block Notes:   We look things up in the current information and if found          we replace it.  At the same time we write the new and          improved BEX syntax to the log file for future use. Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void can't use line -- double size buffer too. loop variable as specified on the text block line shorter of fromlen and tolen if not matched to allow early exit once found duplicate line for rerouting Ty 04/11/98 - Included file may have NOTEXT skip flag set flag to skip included deh-style text skip block Ty 05/17/98 - don't care if this fails ************** Early return killough 8/98: allow hex numbers in input: killough 10/98: fix incorrect usage of feof if the from and to are 4, this may be a sprite rename.  Check it against the array and process it as such if it matches.  Remember that the original names are (and should remain) uppercase. Future: this will be from a separate [SPRITES] block. null terminated list in info.c //jff 3/19/98check pointernot first char Ty 03/18/98 - not using strdup because length is fixed killough 10/98: but it's an array of pointers, so we must use strdup unless we redeclare sprnames and change all else CPhipps - fix constness problem only one will match--quit early next array element lengths of music and sfx are 6 or shorter Try sound effects entries - see sounds.c avoid short prefix erroneous match only one matches, quit early not yet Try music name entries - see sounds.c avoid short prefix erroneous match only one matches, quit early end !found test Nothing we want to handle here--see if strings can deal with it. may be NULL, ignored by free() ==================================================================== deh_procStrings Purpose: Handle BEX [STRINGS] extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs holds the string value of the line maximum string length, bumped 128 at a time as needed holds the final result of the string after concatenation looking for string continuation empty string to start with Ty 04/24/98 - have to allow inbuffer to start with a blank for the continuations of C1TEXT etc. && (*inbuffer != ' ')  skip comment lines killough 11/98 first one--get the key returns TRUE if ok Ty03/29/98 - fix stupid error killough 11/98: allocate enough the first time concatenate the whole buffer if continuation or the value iffirst delete any trailing blanks past the backslash note that blanks before the backslash will be concatenated but ones at the beginning of the next line will not, allowing indentation in the file to read well without affecting the string itself. ready to concatenate didn't have a backslash, trap above would catch that go process the current string supply keyand not search string empty string for the next one ==================================================================== deh_procStringSub Purpose: Common string parsing and handling routine for DEH and BEX Args:    key       -- place to put the mnemonic for the string if found          lookfor   -- original value string to look for          newstring -- string to put in its place if found          fpout     -- file stream pointer for log file (DEHOUT.TXT) Returns: boolean: True if string found, false if not loop exit flag looper orphan originalstring Handle embedded \n's in the incoming string, convert to 0x0a'sfound one skip one extra for second character cap off the target string must have passed an old style string so showBEX ==================================================================== General utility function(s) ==================================================================== ==================================================================== dehReformatStr Purpose: Convert a string into a continuous string with embedded          linefeeds for "\n" sequences in the source string Args:    string -- the string to convert Returns: the converted string (converted in a static buffer) only processing the changed string,  don't need double buffer source target let's play... ==================================================================== rstrip Purpose: Strips trailing blanks off a string Args:    s -- the string to work on Returns: void -- the string is modified in place strip trailing whitespace killough 4/4/98: same here break on first non-whitespace ==================================================================== ptr_lstrip Purpose: Points past leading whitespace in a string Args:    s -- the string to work on Returns: char * pointing to the first nonblank character in the          string.  The original string is not changed. point past leading whitespace ==================================================================== deh_GetData Purpose: Get a key and data pair from a passed string Args:    s -- the string to be examined          k -- a place to put the key          l -- pointer to a long integer to store the number          strval -- a pointer to the place in s where the number                    value comes from.  Pass NULL to not use this.          fpout  -- stream pointer to output log (DEHOUT.TXT) Notes:   Expects a key phrase, optional space, equal sign,          optional space and a value, mostly an int but treated          as a long just in case.  The passed pointer to hold          the key must be DEH_MAXKEYLEN in size. current char to hold value of pair to hold key in progress assume good unless we have problems iterator defaults in case not otherwise set copy it terminate the key before the '=' end of string with no equal sign in case "thiskey =" with no value we've incremented tstrtol(t,NULL,0);  // killough 8/9/98: allow hex or octal input go put the results in the passed pointers may be a faked zero if spaces between key and equal sign, strip them could be a zero-length string pass NULL if you don't want this back pointer, has to be somewhere in s, even if pointing at the zero byte. Emacs style mode select   -*- C++ -*-
 *-----------------------------------------------------------------------------
 *
 *
 *  PrBoom a Doom port merged with LxDoom and LSDLDoom
 *  based on BOOM, a modified and improved DOOM engine
 *  Copyright (C) 1999 by
 *  id Software, Chi Hoang, Lee Killough, Jim Flynn, Rand Phares, Ty Halderman
 *  Copyright (C) 1999-2000 by
 *  Jess Haas, Nicolas Kalkhof, Colin Phipps, Florian Schulze
 *
 *  This program is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU General Public License
 *  as published by the Free Software Foundation; either version 2
 *  of the License, or (at your option) any later version.
 *
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this program; if not, write to the Free Software
 *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
 *  02111-1307, USA.
 *
 * DESCRIPTION:
 *     Dehacked file support
 *     New for the TeamTNT "Boom" engine
 *
 * Author: Ty Halderman, TeamTNT
 *
 *-------------------------------------------------------------------- killough 5/2/98: fixed headers, removed rendunant external declarations: sscanf  killough 10/98: new functions, to allow processing DEH files in-memory (e.g. from wads) Pointer to string Bytes remaining in string Current file descriptor  killough 10/98: emulate IO whether input really comes from a file or not If this is a real file, return regular line read If no more characters Return buffer pointer variables used in other routines in wi_stuff to allow pars in modified games #include "d_deh.h" -- we don't do that here but we declare the variables.  This externalizes everything that there is a string set for in the language files.  See d_deh.h for detailed comments, original English values etc.  These are set to the macro values, which are set by D_ENGLSH.H or D_FRENCH.H(etc).  BEX files are a better way of changing these strings globally by language. ==================================================================== Any of these can be changed using the bex extensions to get the initial values cph - const's
 *     - removed redundant "can't XXX in a netgame" strings.
  PRESSKEY; PRESSKEY; // remove duplicate y/n PRESSYN; PRESSYN; PRESSKEY; PRESSYN; PRESSYN; PRESSKEY; PRESSKEY; PRESSYN; // killough 4/4/98: endchar sc_HUSTR_KEYGREEN   = HUSTR_KEYGREEN;char sc_HUSTR_KEYINDIGO  = HUSTR_KEYINDIGO;char sc_HUSTR_KEYBROWN   = HUSTR_KEYBROWN;char sc_HUSTR_KEYRED     = HUSTR_KEYRED; CPhipps - automap rotate & overlay Ty 03/30/98 - new substitutions for background textures               during int screens end of DOOM Episode 1 end of DOOM Episode 2 end of DOOM Episode 3 end of DOOM Episode 4 DOOM2 after MAP06 DOOM2 after MAP11 DOOM2 after MAP20 DOOM2 after MAP30 DOOM2 going MAP15 to MAP31 DOOM2 going MAP31 to MAP32 Panel behind cast call blank lines are default and are not printed Ty 05/03/98 - externalized
 * cph - updated for prboom  end d_deh.h variable declarations ==================================================================== Do this for a lookup--the pointer (loaded above) is cross-referenced to a string key that is the same as the define above.  We will use strdups to set these new values that we read from the file, orphaning the original value set above. CPhipps - make strings pointed to const doubly indirect pointer to string pointer to lookup string name CPhipps - const, static
 *         - removed redundant "Can't XXX in a netgame" strings
  cph - disabled to prevent format string attacks in WAD files
                                           {&s_QSPROMPT,"QSPROMPT"},
                                           {&s_QLPROMPT,"QLPROMPT"},{c_HUSTR_KEYGREEN,"HUSTR_KEYGREEN"},{c_HUSTR_KEYINDIGO,"HUSTR_KEYINDIGO"},{c_HUSTR_KEYBROWN,"HUSTR_KEYBROWN"},{c_HUSTR_KEYRED,"HUSTR_KEYRED"}, Ty 04/08/98 - added 5 general purpose startup announcement strings for hacker use.  See m_menu.c Ty 05/03/98 CPhipps - const DOOM shareware/registered/retail (Ultimate) names. CPhipps - const**const spares?  Unused. CPhipps - const**const DOOM 2 map names. CPhipps - const**const Plutonia WAD map names. CPhipps - const**const TNT WAD map names. Function prototypes strip trailing whitespace point past leading whitespace Prototypes for block processing functions Pointers to these functions are used as the blocks are encountered. Structure deh_block is used to hold the block names that can be encountered, and the routines to use to decipher them a mnemonic block code name // CPhipps - const* handler input buffer area size, hardcodedfor now killough 8/9/98: make DEH_BLOCKMAX self-adjusting size of array as much of any key as we'll look at number of ints in the mobjinfo_t structure (!) Put all the block header values, and the function to be called when that one is encountered, in this array: CPhipps - static const 0  1  2  3  Ty 03/16/98 corrected from "Sounds" 4  5  6  7  8  9  --  end of standard "deh" entries,     begin BOOM Extensions (BEX) 10  new string changes 11  alternative block marker 12  bex codepointers by mnemonic 13  dummy to handle anything else flag to skip included deh-style text, used with INCLUDE NOTEXT directive MOBJINFO - Dehacked block name = "Thing" Usage: Thing nn (name) These are for mobjinfo_t types.  Each is an integer within the structure, so we can use index of the string in this array to offset by sizeof(int) into the mobjinfo_t array at [nn] * things are base zero but dehacked considers them to start at #1. *** CPhipps - static const .doomednum .spawnstate .spawnhealth .seestate .seesound .reactiontime .attacksound .painstate .painchance .painsound .meleestate .missilestate .deathstate .xdeathstate .deathsound .speed .radius .height .mass .damage .activesound .flags .flags .raisestate Strings that are used to indicate flags ("Bits" in mobjinfo) This is an array of bit masks that are related to p_mobj.h values, using the smae names without the MF_ in front. Ty 08/27/98 new code killough 10/98: Convert array to struct to allow multiple values, make array size variable CPhipps - const* CPhipps - static const call  P_Specialthing when touched block movement can be hit invisible but touchable inert but displayable deaf monster will try to attack right back take at least 1 step before attacking initially hang from ceiling don't apply gravity during play can jump from high places will pick up items goes through walls keep info about sliding along walls allow movement to any height don't cross lines or look at heights don't hit same species, explode on block dropped, not spawned (like ammo clip) use fuzzy draw like spectres puffs instead of blood when shot so it will slide down steps when dead float but not to target height count toward the kills total count toward the items total special handling for flying skulls do not spawn in deathmatch killough 10/98: TRANSLATION consists of 2 bits, not 1: for Boom bug-compatibility use translation table for color (players) use translation table for color (players) unused bit # 1 -- For Boom bug-compatibility unused bit # 2 -- For Boom compatibility for stealth monsters unused bit # 3 -- For Boom compatibility unused bit # 4 -- For Boom compatibility Translucency 25% Translucency 50% Translucency 25% + Translucency 50% = 75% apply translucency to sprite (BOOM) dies on contact with solid objects (MBF) bounces off floors, ceilings and maybe walls a friend of the player(s) (MBF) STATE - Dehacked block name = "Frame" and "Pointer" Usage: Frame nn Usage: Pointer nn (Frame nn) These are indexed separately, for lookup to the actual function pointers.  Here we'll take whatever Dehacked gives us and go from there.  The (Frame nn) after the pointer is the real place to put this value.  The "Pointer" value is an xref that Dehacked uses and is useless to us. * states are base zero and have a dummy #0 (TROO) CPhipps - static const* .sprite (spritenum_t) // an enum .frame (long) .tics (long) .nextstate (statenum_t) This is set in a separate "Pointer" block from Dehacked pointer to first use of action (actionf_t) .misc1 (long) .misc2 (long) SFXINFO_STRUCT - Dehacked block name = "Sounds" Sound effects, typically not changed (redirected, and new sfx put into the pwad, but not changed here.  Can you tell that Gregdidn't know what they were for, mostly?  Can you tell that I don't either? Mostly I just put these into the same slots as they are in the struct. This may not be supported in our -deh option if it doesn't make sense by then. * sounds are base zero but have a dummy #0 CPhipps - static const* pointer to a name string, changed in text .singularity (int, one at a time flag) .priority .link (sfxinfo_t*) referenced sound if linked .pitch .volume .data (SAMPLE*) sound data .usefulness .lumpnum MUSICINFO is not supported in Dehacked.  Ignored here. * music entries are base zero but have a dummy #0 CPhipps - unused? SPRITE - Dehacked block name = "Sprite" Usage = Sprite nn Sprite redirection by offset into the text area - unsupported by BOOM * sprites are base zero and dehacked uses it that way. CPhipps - static const* supposed to be the offset into the text section AMMO - Dehacked block name = "Ammo" usage = Ammo n (name) Ammo information for the few types of ammo CPhipps - static const* maxammo[] clipammo[] WEAPONS - Dehacked block name = "Weapon" Usage: Weapon nn (name) Basically a list of frames and what kind of ammo (see above)it uses. CPhipps - static const* .ammo .upstate .downstate .readystate .atkstate .flashstate CHEATS - Dehacked block name = "Cheat" Usage: Cheat 0 Always uses a zero in the dehacked file, for consistency.  No meaning. These are just plain funky terms compared with id's killough 4/18/98: integrated into main cheat table now (see st_stuff.c) MISC - Dehacked block name = "Misc" Usage: Misc 0 Always uses a zero in the dehacked file, for consistency.  No meaning. CPhipps - static const* initial_health initial_bullets maxhealth max_armor green_armor_class blue_armor_class max_soul soul_health mega_health god_health idfa_armor idfa_armor_class idkfa_armor idkfa_armor_class BFGCELLS Unknown--not a specific number it seems, but the logic has to be here somewhere or it'd happen always TEXT - Dehacked block name = "Text" Usage: Text fromlen tolen Dehacked allows a bit of adjustment to the length (why?) BEX extension [CODEPTR] Usage: Start block, then each line is: FRAME nnn = PointerMnemonic External references to action functions scattered about the code killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 actual pointer to the subroutine mnemonic lookup string to be specified in BEX CPhipps - const* CPhipps - static const killough 8/9/98 killough 10/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 killough 11/98 This NULL entry must be the last in the list Ty 05/16/98 to hold startup code pointers from INFO.C CPhipps - static ==================================================================== ProcessDehFile Purpose: Read and process a DEH or BEX file Args:    filename    -- name of the DEH/BEX file          outfilename -- output file (DEHOUT.TXT), appended to here Returns: void killough 10/98: substantially modified to allow input from wad lumps instead of .deh files. In case -dehout was used killough 10/98 Place to put the primary infostring Open output file if we're writing output to allow append to output log killough 10/98: allow DEH files to come from wad lumps should be checked up front anyway DEH file comes from lump indicated by third argument killough 10/98: only run once, by keeping index static remember what they start as for deh xref loop until end of file Blank line or comment line  -- If DEH_BLOCKMAX is set right, the processing is independently -- handled based on data in the deh_blocks[] structure array killough 10/98: INCLUDE code rewritten to allow arbitrary nesting, and to greatly simplify code, fix memory leaks, other bugs include a file preserve state while including a file killough 10/98: moved to here killough 10/98 killough 10/98: exclude if inside wads (only to discourage the practice, since the code could otherwise handle it) check for no-text directive, used when including a DEH file but using the BEX format to handle strings killough 10/98: Second argument must be NULL to prevent closing fileout too soon do the included file matches one call function we got one, that's enough for this block Mark purgable Close real file ==================================================================== deh_procBexCodePointers Purpose: Handle [CODEPTR] block, BOOM Extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void to hold the codepointer mnemonic looper know if we found this one during lookup or not Ty 05/16/98 - initialize it to something, dummy! for this one, we just read 'em until we hit a blank line killough 11/98: really exit on blank line killough 8/98: allow hex numbers in input: NOTE: different format from normal early return killough 10/98: fix SegViol reusing the key area to prefix the mnemonic incremented to start at zero at the top of the loop Ty 05/16/98 - fix loop logic to look for null ending entry Ty 06/01/98  - add  to states[].action for new djgcc version assign--------------------------------------------------------------------------- To be on the safe, compatible side, we manually convert DEH bitflags to prboom types - POPE--------------------------------------------------------------------------- cf linuxdoom-1.10 p_mobj.h  0 Can be picked up. When touched the thing can be picked up. 1 Obstacle. The thing is solid and will not let you (or others) pass through it 2 Shootable. Can be shot. 3 Total Invisibility. Invisible, but can be touched 4 Don't use the blocklinks (inert but displayable) 5 Semi deaf. The thing is a deaf monster 6 In pain. Will try to attack right back after being hit 7 Steps before attack. Will take at least one step before attacking 8 Hangs from ceiling. When the level starts, this thing will be at ceiling height. 9 No gravity – Gravity does not affect this thing 10 Travels over cliffs – Monsters normally do not walk off ledges/steps they could not walk up. With this set they can walk off any height of cliff. Usually only used for flying monsters. 11 Pick up items – The thing can pick up gettable items. 12 No clipping - Thing can walk through walls. 13 Slides along walls – Keep info about sliding along walls (don’t really know much about this one). 14 Floating – Thing can move to any height 15 Semi no clipping – Don’t cross lines or look at teleport heights. (don’t really know much about this one either). 16 Projectiles – Behaves like a projectile, explodes when hitting something that blocks movement 17 Disappearing weapon – Dropped, not spawned (like an ammo clip) I have not had much success in using this one. 18 Partial invisibility – Drawn like a spectre. 19 Puffs (vs. bleeds) – If hit will spawn bullet puffs instead of blood splats. 20 Sliding helpless – Will slide down steps when dead. 21 No auto levelling - float but not to target height (?) 22 Affects kill % – counted as a killable enemy and affects percentage kills on level summary. 23 Affects item % –affects percentage items gathered on level summary. 24 Running - special handling for flying skulls. 25 Not in deathmatch - do not spawn in deathmatch (like keys) 26 Color 1 (grey / red) 27 Color 2 (brown / red) 28 and 29 allow the green colours in a thing’s graphics to be remapped to a different colour like the players uniforms in multiplayer games. Leaving all the bits alone, the thing stays green. Setting 26 it becomes grey. Setting 27 it becomes brown. Setting both 26 and 27 it becomes red.--------------------------------------------------------------------------- See usage below for an explanation of this function's existence - POPE--------------------------------------------------------------------------- ==================================================================== deh_procThing Purpose: Handle DEH Thing block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Ty 8/27/98 - revised to also allow mnemonics for bit masks for monster attributes All deh values are ints or longs killough 8/98: allow hex numbers in input: Note that the mobjinfo[] array is base zero, but object numbers in the dehacked file start with one.  Grumble. now process the stuff Note that for Things we can look up the key and use its offset in the array of key strings as an int offset in the structure get a line until a blank or end of file--it's not blank now because it has our incoming key in it killough 11/98: really bail out on blank lines (break != continue) bail out with blank line between sections returns TRUE if ok standard value set The old code here was the cause of a DEH-related bug in prboom. When the mobjinfo_t.flags member was graduated to an int64, this code was caught unawares and was indexing each property of the mobjinfo as if it were still an int32. This caused sets of the "raisestate" member to partially overwrite the "flags" member, thus screwing everything up and making most DEH patches result in unshootable enemy types. Moved to a separate function above and stripped of all hairy struct address indexing. - POPE bit set proff figure out what the bits are killough 10/98: replace '+' kludge with strtok() loop Fix error-handling case ('found' var wasn't being reset) Use OR logic instead of addition, to allow repetition Don't worry about conversion -- simply print values ==================================================================== deh_procFrame Purpose: Handle DEH Frame block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Sprite number Sprite subnumber long Duration long Next frame Codep frame (not set in Frame deh block) nop  Unknown 1 long Unknown 2 long ==================================================================== deh_procPointer Purpose: Handle DEH Code pointer block, can use BEX [CODEPTR] instead Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs looper NOTE: different format from normal killough 8/98: allow hex numbers in input, fix error case: killough 11/98 returns TRUE if ok Codep frame (not set in Frame deh block) Write BEX-oriented line to match: ==================================================================== deh_procSounds Purpose: Handle DEH Sounds block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Offset nop  we don't know what this is, I don't think Zero/One Value Zero 1 Zero 2 Zero 3 Zero 4 killough 5/3/98: changed cast Neg. One 1 Neg. One 2 ==================================================================== deh_procAmmo Purpose: Handle DEH Ammo block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Max ammo Per ammo ==================================================================== deh_procWeapon Purpose: Handle DEH Weapon block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs killough 8/98: allow hex numbers in input: killough 11/98 returns TRUE if ok Ammo type Deselect frame Select frame Bobbing frame Shooting frame Firing frame ==================================================================== deh_procSprite Purpose: Dummy - we do not support the DEH Sprite block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void Not supported Too little is known about what this is supposed to do, and there are better ways of handling sprite renaming.  Not supported. killough 8/98: allow hex numbers in input: killough 11/98 ignore line ==================================================================== deh_procPars Purpose: Handle BEX extension for PAR times Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void extension new item, par times usage: After [PARS] Par 0 section identifier, use one or more of these lines:  par 3 5 120  par 14 230 The first would make the par for E3M5 be 120 seconds, and the second one makes the par for MAP14 be 230 seconds.  The number of parameters on the line determines which group of par values is being changed.  Error checking is done based on current fixed array sizes of[4][10] and [32] killough 8/98: allow hex numbers in input: indexnum is a dummy entry lowercase it killough 11/98 not 3 not 2 is 2 Ty 07/11/98 - wrong range check, not zero-based base 0 array (but 1-based parm) is 3 note that though it's a [4][10] array, the "left" and "top" aren't used, effectively making it a base 1 array. Ty 07/11/98 - level was being checked against max 3 - dumb error Note that episode 4 does not have par times per original design in Ultimate DOOM so that is not supported here. ==================================================================== deh_procCheat Purpose: Handle DEH Cheat block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done   char key[DEH_MAXKEYLEN];
   char inbuffer[DEH_BUFFERMAX];
   uint_64_t value;      // All deh values are ints or longs
   char ch = 0; // CPhipps - `writable' null string to initialise...
   char *strval = &ch;  // pointer to the value area
   int ix, iy;   // array indices
   char *p;  // utility pointer

   if (fpout) fdprintf(fpout,"Processing Cheat: %s\n",line);

   strncpy(inbuffer,line,DEH_BUFFERMAX);
   while (!dehfeof(fpin) && *inbuffer && (*inbuffer != ' '))
   {
      if (!dehfgets(inbuffer, sizeof(inbuffer), fpin)) break;
      if (!*inbuffer) break;       // killough 11/98
      if (!deh_GetData(inbuffer,key,&value,&strval,fpout)) // returns TRUE if ok
      {
         if (fpout) fdprintf(fpout,"Bad data pair in '%s'\n",inbuffer);
         continue;
      }
      // Otherwise we got a (perhaps valid) cheat name,
      // so look up the key in the array

      // killough 4/18/98: use main cheat code table in st_stuff.c now
      for (ix=0; cheat[ix].cheat; ix++)
         if (cheat[ix].deh_cheat)   // killough 4/18/98: skip non-deh
         {
            if (!stricmp(key,cheat[ix].deh_cheat))  // found the cheat, ignored case
            {
               // replace it but don't overflow it.  Use current length as limit.
               // Ty 03/13/98 - add 0xff code
               // Deal with the fact that the cheats in deh files are extended
               // with character 0xFF to the original cheat length, which we don't do.
               for (iy=0; strval[iy]; iy++)
                  strval[iy] = (strval[iy]==(char)0xff) ? '\0' : strval[iy];

               iy = ix;     // killough 4/18/98

               // Ty 03/14/98 - skip leading spaces
               p = strval;
               while (*p == ' ') ++p;
               // Ty 03/16/98 - change to use a strdup and orphan the original
               // Also has the advantage of allowing length changes.
               // strncpy(cheat[iy].cheat,p,strlen(cheat[iy].cheat));
#if 0
               {    // killough 9/12/98: disable cheats which are prefixes of this one
                  int i;
                  for (i=0; cheat[i].cheat; i++)
                     if (cheat[i].when & not_deh &&
                           !strncasecmp(cheat[i].cheat,
                                        cheat[iy].cheat,
                                        strlen(cheat[i].cheat)) && i != iy)
                        cheat[i].deh_modified = true;
               }
#endif
               cheat[iy].cheat = strdup(p);
               if (fpout) fdprintf(fpout,
                                     "Assigned new cheat '%s' to cheat '%s'at index %d\n",
                                     p, cheat[ix].deh_cheat, iy); // killough 4/18/98
            }
         }
      if (fpout) fdprintf(fpout,"- %s\n",inbuffer);
   }
   return;
 ==================================================================== deh_procMisc Purpose: Handle DEH Misc block Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void done All deh values are ints or longs killough 11/98 returns TRUE if ok Otherwise it's ok Initial Health Initial Bullets Max Health Max Armor Green Armor Class Blue Armor Class Max Soulsphere Soulsphere Health Megasphere Health God Mode Health IDFA Armor IDFA Armor Class IDKFA Armor IDKFA Armor Class BFG Cells/Shot Monsters Infight No such switch in DOOM - nop  ==================================================================== deh_procText Purpose: Handle DEH Text block Notes:   We look things up in the current information and if found          we replace it.  At the same time we write the new and          improved BEX syntax to the log file for future use. Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void can't use line -- double size buffer too. loop variable as specified on the text block line shorter of fromlen and tolen if not matched to allow early exit once found duplicate line for rerouting Ty 04/11/98 - Included file may have NOTEXT skip flag set flag to skip included deh-style text skip block Ty 05/17/98 - don't care if this fails ************** Early return killough 8/98: allow hex numbers in input: killough 10/98: fix incorrect usage of feof if the from and to are 4, this may be a sprite rename.  Check it against the array and process it as such if it matches.  Remember that the original names are (and should remain) uppercase. Future: this will be from a separate [SPRITES] block. null terminated list in info.c //jff 3/19/98check pointernot first char Ty 03/18/98 - not using strdup because length is fixed killough 10/98: but it's an array of pointers, so we must use strdup unless we redeclare sprnames and change all else CPhipps - fix constness problem only one will match--quit early next array element lengths of music and sfx are 6 or shorter Try sound effects entries - see sounds.c avoid short prefix erroneous match only one matches, quit early not yet Try music name entries - see sounds.c avoid short prefix erroneous match only one matches, quit early end !found test Nothing we want to handle here--see if strings can deal with it. may be NULL, ignored by free() ==================================================================== deh_procStrings Purpose: Handle BEX [STRINGS] extension Args:    fpin  -- input file stream          fpout -- output file stream (DEHOUT.TXT)          line  -- current line in file to process Returns: void All deh values are ints or longs holds the string value of the line maximum string length, bumped 128 at a time as needed holds the final result of the string after concatenation looking for string continuation empty string to start with Ty 04/24/98 - have to allow inbuffer to start with a blank for the continuations of C1TEXT etc. && (*inbuffer != ' ')  skip comment lines killough 11/98 first one--get the key returns TRUE if ok Ty03/29/98 - fix stupid error killough 11/98: allocate enough the first time concatenate the whole buffer if continuation or the value iffirst delete any trailing blanks past the backslash note that blanks before the backslash will be concatenated but ones at the beginning of the next line will not, allowing indentation in the file to read well without affecting the string itself. ready to concatenate didn't have a backslash, trap above would catch that go process the current string supply keyand not search string empty string for the next one ==================================================================== deh_procStringSub Purpose: Common string parsing and handling routine for DEH and BEX Args:    key       -- place to put the mnemonic for the string if found          lookfor   -- original value string to look for          newstring -- string to put in its place if found          fpout     -- file stream pointer for log file (DEHOUT.TXT) Returns: boolean: True if string found, false if not loop exit flag looper orphan originalstring Handle embedded \n's in the incoming string, convert to 0x0a'sfound one skip one extra for second character cap off the target string must have passed an old style string so showBEX ==================================================================== General utility function(s) ==================================================================== ==================================================================== dehReformatStr Purpose: Convert a string into a continuous string with embedded          linefeeds for "\n" sequences in the source string Args:    string -- the string to convert Returns: the converted string (converted in a static buffer) only processing the changed string,  don't need double buffer source target let's play... ==================================================================== rstrip Purpose: Strips trailing blanks off a string Args:    s -- the string to work on Returns: void -- the string is modified in place strip trailing whitespace killough 4/4/98: same here break on first non-whitespace ==================================================================== ptr_lstrip Purpose: Points past leading whitespace in a string Args:    s -- the string to work on Returns: char * pointing to the first nonblank character in the          string.  The original string is not changed. point past leading whitespace ==================================================================== deh_GetData Purpose: Get a key and data pair from a passed string Args:    s -- the string to be examined          k -- a place to put the key          l -- pointer to a long integer to store the number          strval -- a pointer to the place in s where the number                    value comes from.  Pass NULL to not use this.          fpout  -- stream pointer to output log (DEHOUT.TXT) Notes:   Expects a key phrase, optional space, equal sign,          optional space and a value, mostly an int but treated          as a long just in case.  The passed pointer to hold          the key must be DEH_MAXKEYLEN in size. current char to hold value of pair to hold key in progress assume good unless we have problems iterator defaults in case not otherwise set copy it terminate the key before the '=' end of string with no equal sign in case "thiskey =" with no value we've incremented tstrtol(t,NULL,0);  // killough 8/9/98: allow hex or octal input go put the results in the passed pointers may be a faked zero if spaces between key and equal sign, strip them could be a zero-length string pass NULL if you don't want this back pointer, has to be somewhere in s, even if pointing at the zero byte.